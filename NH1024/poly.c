#include "poly.h"
#include "ntt.h"
#include "../common/randombytes.h"
#include "../common/reduce.h"
#include "../common/fips202.h"

#include <assert.h>
#include <inttypes.h>


#define TO_BYTES_BLOCK(i) do{\
  x = p->coeffs[4*i+0];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t0 = m ^ t;\
  x = p->coeffs[4*i+1];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t1 = m ^ t;\
  x = p->coeffs[4*i+2];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t2 = m ^ t;\
  x = p->coeffs[4*i+3];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t3 = m ^ t;\
  r[7*i+0] =  t0 & 0xff;\
  r[7*i+1] = (t0 >> 8) | (t1 << 6);\
  r[7*i+2] = (t1 >> 2);\
  r[7*i+3] = (t1 >> 10) | (t2 << 4);\
  r[7*i+4] = (t2 >> 4);\
  r[7*i+5] = (t2 >> 12) | (t3 << 2);\
  r[7*i+6] = (t3 >> 6);\
} while(0)

void poly_tobytes(unsigned char *r, const poly *p)
{
  uint16_t t0,t1,t2,t3;

  uint16_t x, m, r2, t;
  int16_t c;
  uint32_t u;

  TO_BYTES_BLOCK(0);
  TO_BYTES_BLOCK(1);
  TO_BYTES_BLOCK(2);
  TO_BYTES_BLOCK(3);
  TO_BYTES_BLOCK(4);
  TO_BYTES_BLOCK(5);
  TO_BYTES_BLOCK(6);
  TO_BYTES_BLOCK(7);
  TO_BYTES_BLOCK(8);
  TO_BYTES_BLOCK(9);
  TO_BYTES_BLOCK(10);
  TO_BYTES_BLOCK(11);
  TO_BYTES_BLOCK(12);
  TO_BYTES_BLOCK(13);
  TO_BYTES_BLOCK(14);
  TO_BYTES_BLOCK(15);
  TO_BYTES_BLOCK(16);
  TO_BYTES_BLOCK(17);
  TO_BYTES_BLOCK(18);
  TO_BYTES_BLOCK(19);
  TO_BYTES_BLOCK(20);
  TO_BYTES_BLOCK(21);
  TO_BYTES_BLOCK(22);
  TO_BYTES_BLOCK(23);
  TO_BYTES_BLOCK(24);
  TO_BYTES_BLOCK(25);
  TO_BYTES_BLOCK(26);
  TO_BYTES_BLOCK(27);
  TO_BYTES_BLOCK(28);
  TO_BYTES_BLOCK(29);
  TO_BYTES_BLOCK(30);
  TO_BYTES_BLOCK(31);
  TO_BYTES_BLOCK(32);
  TO_BYTES_BLOCK(33);
  TO_BYTES_BLOCK(34);
  TO_BYTES_BLOCK(35);
  TO_BYTES_BLOCK(36);
  TO_BYTES_BLOCK(37);
  TO_BYTES_BLOCK(38);
  TO_BYTES_BLOCK(39);
  TO_BYTES_BLOCK(40);
  TO_BYTES_BLOCK(41);
  TO_BYTES_BLOCK(42);
  TO_BYTES_BLOCK(43);
  TO_BYTES_BLOCK(44);
  TO_BYTES_BLOCK(45);
  TO_BYTES_BLOCK(46);
  TO_BYTES_BLOCK(47);
  TO_BYTES_BLOCK(48);
  TO_BYTES_BLOCK(49);
  TO_BYTES_BLOCK(50);
  TO_BYTES_BLOCK(51);
  TO_BYTES_BLOCK(52);
  TO_BYTES_BLOCK(53);
  TO_BYTES_BLOCK(54);
  TO_BYTES_BLOCK(55);
  TO_BYTES_BLOCK(56);
  TO_BYTES_BLOCK(57);
  TO_BYTES_BLOCK(58);
  TO_BYTES_BLOCK(59);
  TO_BYTES_BLOCK(60);
  TO_BYTES_BLOCK(61);
  TO_BYTES_BLOCK(62);
  TO_BYTES_BLOCK(63);
  TO_BYTES_BLOCK(64);
  TO_BYTES_BLOCK(65);
  TO_BYTES_BLOCK(66);
  TO_BYTES_BLOCK(67);
  TO_BYTES_BLOCK(68);
  TO_BYTES_BLOCK(69);
  TO_BYTES_BLOCK(70);
  TO_BYTES_BLOCK(71);
  TO_BYTES_BLOCK(72);
  TO_BYTES_BLOCK(73);
  TO_BYTES_BLOCK(74);
  TO_BYTES_BLOCK(75);
  TO_BYTES_BLOCK(76);
  TO_BYTES_BLOCK(77);
  TO_BYTES_BLOCK(78);
  TO_BYTES_BLOCK(79);
  TO_BYTES_BLOCK(80);
  TO_BYTES_BLOCK(81);
  TO_BYTES_BLOCK(82);
  TO_BYTES_BLOCK(83);
  TO_BYTES_BLOCK(84);
  TO_BYTES_BLOCK(85);
  TO_BYTES_BLOCK(86);
  TO_BYTES_BLOCK(87);
  TO_BYTES_BLOCK(88);
  TO_BYTES_BLOCK(89);
  TO_BYTES_BLOCK(90);
  TO_BYTES_BLOCK(91);
  TO_BYTES_BLOCK(92);
  TO_BYTES_BLOCK(93);
  TO_BYTES_BLOCK(94);
  TO_BYTES_BLOCK(95);
  TO_BYTES_BLOCK(96);
  TO_BYTES_BLOCK(97);
  TO_BYTES_BLOCK(98);
  TO_BYTES_BLOCK(99);
  TO_BYTES_BLOCK(100);
  TO_BYTES_BLOCK(101);
  TO_BYTES_BLOCK(102);
  TO_BYTES_BLOCK(103);
  TO_BYTES_BLOCK(104);
  TO_BYTES_BLOCK(105);
  TO_BYTES_BLOCK(106);
  TO_BYTES_BLOCK(107);
  TO_BYTES_BLOCK(108);
  TO_BYTES_BLOCK(109);
  TO_BYTES_BLOCK(110);
  TO_BYTES_BLOCK(111);
  TO_BYTES_BLOCK(112);
  TO_BYTES_BLOCK(113);
  TO_BYTES_BLOCK(114);
  TO_BYTES_BLOCK(115);
  TO_BYTES_BLOCK(116);
  TO_BYTES_BLOCK(117);
  TO_BYTES_BLOCK(118);
  TO_BYTES_BLOCK(119);
  TO_BYTES_BLOCK(120);
  TO_BYTES_BLOCK(121);
  TO_BYTES_BLOCK(122);
  TO_BYTES_BLOCK(123);
  TO_BYTES_BLOCK(124);
  TO_BYTES_BLOCK(125);
  TO_BYTES_BLOCK(126);
  TO_BYTES_BLOCK(127);
  TO_BYTES_BLOCK(128);
  TO_BYTES_BLOCK(129);
  TO_BYTES_BLOCK(130);
  TO_BYTES_BLOCK(131);
  TO_BYTES_BLOCK(132);
  TO_BYTES_BLOCK(133);
  TO_BYTES_BLOCK(134);
  TO_BYTES_BLOCK(135);
  TO_BYTES_BLOCK(136);
  TO_BYTES_BLOCK(137);
  TO_BYTES_BLOCK(138);
  TO_BYTES_BLOCK(139);
  TO_BYTES_BLOCK(140);
  TO_BYTES_BLOCK(141);
  TO_BYTES_BLOCK(142);
  TO_BYTES_BLOCK(143);
  TO_BYTES_BLOCK(144);
  TO_BYTES_BLOCK(145);
  TO_BYTES_BLOCK(146);
  TO_BYTES_BLOCK(147);
  TO_BYTES_BLOCK(148);
  TO_BYTES_BLOCK(149);
  TO_BYTES_BLOCK(150);
  TO_BYTES_BLOCK(151);
  TO_BYTES_BLOCK(152);
  TO_BYTES_BLOCK(153);
  TO_BYTES_BLOCK(154);
  TO_BYTES_BLOCK(155);
  TO_BYTES_BLOCK(156);
  TO_BYTES_BLOCK(157);
  TO_BYTES_BLOCK(158);
  TO_BYTES_BLOCK(159);
  TO_BYTES_BLOCK(160);
  TO_BYTES_BLOCK(161);
  TO_BYTES_BLOCK(162);
  TO_BYTES_BLOCK(163);
  TO_BYTES_BLOCK(164);
  TO_BYTES_BLOCK(165);
  TO_BYTES_BLOCK(166);
  TO_BYTES_BLOCK(167);
  TO_BYTES_BLOCK(168);
  TO_BYTES_BLOCK(169);
  TO_BYTES_BLOCK(170);
  TO_BYTES_BLOCK(171);
  TO_BYTES_BLOCK(172);
  TO_BYTES_BLOCK(173);
  TO_BYTES_BLOCK(174);
  TO_BYTES_BLOCK(175);
  TO_BYTES_BLOCK(176);
  TO_BYTES_BLOCK(177);
  TO_BYTES_BLOCK(178);
  TO_BYTES_BLOCK(179);
  TO_BYTES_BLOCK(180);
  TO_BYTES_BLOCK(181);
  TO_BYTES_BLOCK(182);
  TO_BYTES_BLOCK(183);
  TO_BYTES_BLOCK(184);
  TO_BYTES_BLOCK(185);
  TO_BYTES_BLOCK(186);
  TO_BYTES_BLOCK(187);
  TO_BYTES_BLOCK(188);
  TO_BYTES_BLOCK(189);
  TO_BYTES_BLOCK(190);
  TO_BYTES_BLOCK(191);
  TO_BYTES_BLOCK(192);
  TO_BYTES_BLOCK(193);
  TO_BYTES_BLOCK(194);
  TO_BYTES_BLOCK(195);
  TO_BYTES_BLOCK(196);
  TO_BYTES_BLOCK(197);
  TO_BYTES_BLOCK(198);
  TO_BYTES_BLOCK(199);
  TO_BYTES_BLOCK(200);
  TO_BYTES_BLOCK(201);
  TO_BYTES_BLOCK(202);
  TO_BYTES_BLOCK(203);
  TO_BYTES_BLOCK(204);
  TO_BYTES_BLOCK(205);
  TO_BYTES_BLOCK(206);
  TO_BYTES_BLOCK(207);
  TO_BYTES_BLOCK(208);
  TO_BYTES_BLOCK(209);
  TO_BYTES_BLOCK(210);
  TO_BYTES_BLOCK(211);
  TO_BYTES_BLOCK(212);
  TO_BYTES_BLOCK(213);
  TO_BYTES_BLOCK(214);
  TO_BYTES_BLOCK(215);
  TO_BYTES_BLOCK(216);
  TO_BYTES_BLOCK(217);
  TO_BYTES_BLOCK(218);
  TO_BYTES_BLOCK(219);
  TO_BYTES_BLOCK(220);
  TO_BYTES_BLOCK(221);
  TO_BYTES_BLOCK(222);
  TO_BYTES_BLOCK(223);
  TO_BYTES_BLOCK(224);
  TO_BYTES_BLOCK(225);
  TO_BYTES_BLOCK(226);
  TO_BYTES_BLOCK(227);
  TO_BYTES_BLOCK(228);
  TO_BYTES_BLOCK(229);
  TO_BYTES_BLOCK(230);
  TO_BYTES_BLOCK(231);
  TO_BYTES_BLOCK(232);
  TO_BYTES_BLOCK(233);
  TO_BYTES_BLOCK(234);
  TO_BYTES_BLOCK(235);
  TO_BYTES_BLOCK(236);
  TO_BYTES_BLOCK(237);
  TO_BYTES_BLOCK(238);
  TO_BYTES_BLOCK(239);
  TO_BYTES_BLOCK(240);
  TO_BYTES_BLOCK(241);
  TO_BYTES_BLOCK(242);
  TO_BYTES_BLOCK(243);
  TO_BYTES_BLOCK(244);
  TO_BYTES_BLOCK(245);
  TO_BYTES_BLOCK(246);
  TO_BYTES_BLOCK(247);
  TO_BYTES_BLOCK(248);
  TO_BYTES_BLOCK(249);
  TO_BYTES_BLOCK(250);
  TO_BYTES_BLOCK(251);
  TO_BYTES_BLOCK(252);
  TO_BYTES_BLOCK(253);
  TO_BYTES_BLOCK(254);
  TO_BYTES_BLOCK(255);
}

#define COMPRESS_SUB_BLOCK(j,i) do{\
  x = p->coeffs[i+j];\
  u = ((uint32_t) x * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = p->coeffs[i+j];\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r2^m;\
  t2 = t2 & c;\
  t[j] = m ^ t2; \
      t[j] = (((t[j] << 3) + NEWHOPE_Q/2)/NEWHOPE_Q) & 0x7;\
} while(0)

#define COMPRESS_BLOCK(i) do{\
   COMPRESS_SUB_BLOCK(0, i);\
   COMPRESS_SUB_BLOCK(1, i);\
   COMPRESS_SUB_BLOCK(2, i);\
   COMPRESS_SUB_BLOCK(3, i);\
   COMPRESS_SUB_BLOCK(4, i);\
   COMPRESS_SUB_BLOCK(5, i);\
   COMPRESS_SUB_BLOCK(6, i);\
   COMPRESS_SUB_BLOCK(7, i);\
    r[k]   =  t[0]       | (t[1] << 3) | (t[2] << 6);\
    r[k+1] = (t[2] >> 2) | (t[3] << 1) | (t[4] << 4) | (t[5] << 7);\
    r[k+2] = (t[5] >> 1) | (t[6] << 2) | (t[7] << 5);\
    k += 3;\
} while(0)

void poly_compress(unsigned char *r, const poly *p)
{
  unsigned int k=0;
  uint32_t t[8];
  uint16_t m,r2, t2, x;
  int16_t c;
  uint32_t u;
  
  COMPRESS_BLOCK(0);
  COMPRESS_BLOCK(8);
  COMPRESS_BLOCK(16);
  COMPRESS_BLOCK(24);
  COMPRESS_BLOCK(32);
  COMPRESS_BLOCK(40);
  COMPRESS_BLOCK(48);
  COMPRESS_BLOCK(56);
  COMPRESS_BLOCK(64);
  COMPRESS_BLOCK(72);
  COMPRESS_BLOCK(80);
  COMPRESS_BLOCK(88);
  COMPRESS_BLOCK(96);
  COMPRESS_BLOCK(104);
  COMPRESS_BLOCK(112);
  COMPRESS_BLOCK(120);
  COMPRESS_BLOCK(128);
  COMPRESS_BLOCK(136);
  COMPRESS_BLOCK(144);
  COMPRESS_BLOCK(152);
  COMPRESS_BLOCK(160);
  COMPRESS_BLOCK(168);
  COMPRESS_BLOCK(176);
  COMPRESS_BLOCK(184);
  COMPRESS_BLOCK(192);
  COMPRESS_BLOCK(200);
  COMPRESS_BLOCK(208);
  COMPRESS_BLOCK(216);
  COMPRESS_BLOCK(224);
  COMPRESS_BLOCK(232);
  COMPRESS_BLOCK(240);
  COMPRESS_BLOCK(248);
  COMPRESS_BLOCK(256);
  COMPRESS_BLOCK(264);
  COMPRESS_BLOCK(272);
  COMPRESS_BLOCK(280);
  COMPRESS_BLOCK(288);
  COMPRESS_BLOCK(296);
  COMPRESS_BLOCK(304);
  COMPRESS_BLOCK(312);
  COMPRESS_BLOCK(320);
  COMPRESS_BLOCK(328);
  COMPRESS_BLOCK(336);
  COMPRESS_BLOCK(344);
  COMPRESS_BLOCK(352);
  COMPRESS_BLOCK(360);
  COMPRESS_BLOCK(368);
  COMPRESS_BLOCK(376);
  COMPRESS_BLOCK(384);
  COMPRESS_BLOCK(392);
  COMPRESS_BLOCK(400);
  COMPRESS_BLOCK(408);
  COMPRESS_BLOCK(416);
  COMPRESS_BLOCK(424);
  COMPRESS_BLOCK(432);
  COMPRESS_BLOCK(440);
  COMPRESS_BLOCK(448);
  COMPRESS_BLOCK(456);
  COMPRESS_BLOCK(464);
  COMPRESS_BLOCK(472);
  COMPRESS_BLOCK(480);
  COMPRESS_BLOCK(488);
  COMPRESS_BLOCK(496);
  COMPRESS_BLOCK(504);
  COMPRESS_BLOCK(512);
  COMPRESS_BLOCK(520);
  COMPRESS_BLOCK(528);
  COMPRESS_BLOCK(536);
  COMPRESS_BLOCK(544);
  COMPRESS_BLOCK(552);
  COMPRESS_BLOCK(560);
  COMPRESS_BLOCK(568);
  COMPRESS_BLOCK(576);
  COMPRESS_BLOCK(584);
  COMPRESS_BLOCK(592);
  COMPRESS_BLOCK(600);
  COMPRESS_BLOCK(608);
  COMPRESS_BLOCK(616);
  COMPRESS_BLOCK(624);
  COMPRESS_BLOCK(632);
  COMPRESS_BLOCK(640);
  COMPRESS_BLOCK(648);
  COMPRESS_BLOCK(656);
  COMPRESS_BLOCK(664);
  COMPRESS_BLOCK(672);
  COMPRESS_BLOCK(680);
  COMPRESS_BLOCK(688);
  COMPRESS_BLOCK(696);
  COMPRESS_BLOCK(704);
  COMPRESS_BLOCK(712);
  COMPRESS_BLOCK(720);
  COMPRESS_BLOCK(728);
  COMPRESS_BLOCK(736);
  COMPRESS_BLOCK(744);
  COMPRESS_BLOCK(752);
  COMPRESS_BLOCK(760);
  COMPRESS_BLOCK(768);
  COMPRESS_BLOCK(776);
  COMPRESS_BLOCK(784);
  COMPRESS_BLOCK(792);
  COMPRESS_BLOCK(800);
  COMPRESS_BLOCK(808);
  COMPRESS_BLOCK(816);
  COMPRESS_BLOCK(824);
  COMPRESS_BLOCK(832);
  COMPRESS_BLOCK(840);
  COMPRESS_BLOCK(848);
  COMPRESS_BLOCK(856);
  COMPRESS_BLOCK(864);
  COMPRESS_BLOCK(872);
  COMPRESS_BLOCK(880);
  COMPRESS_BLOCK(888);
  COMPRESS_BLOCK(896);
  COMPRESS_BLOCK(904);
  COMPRESS_BLOCK(912);
  COMPRESS_BLOCK(920);
  COMPRESS_BLOCK(928);
  COMPRESS_BLOCK(936);
  COMPRESS_BLOCK(944);
  COMPRESS_BLOCK(952);
  COMPRESS_BLOCK(960);
  COMPRESS_BLOCK(968);
  COMPRESS_BLOCK(976);
  COMPRESS_BLOCK(984);
  COMPRESS_BLOCK(992);
  COMPRESS_BLOCK(1000);
  COMPRESS_BLOCK(1008);
  COMPRESS_BLOCK(1016);
}

#define DECOMPRESS_SUB_BLOCK(j, i) do{\
      r->coeffs[i+j] = ((uint32_t)r->coeffs[i+j] * NEWHOPE_Q + 4) >> 3;\
} while(0)

#define DECOMPRESS_BLOCK(i) do{\
    r->coeffs[i+0] =  a[0] & 7;\
    r->coeffs[i+1] = (a[0] >> 3) & 7;\
    r->coeffs[i+2] = (a[0] >> 6) | ((a[1] << 2) & 4);\
    r->coeffs[i+3] = (a[1] >> 1) & 7;\
    r->coeffs[i+4] = (a[1] >> 4) & 7;\
    r->coeffs[i+5] = (a[1] >> 7) | ((a[2] << 1) & 6);\
    r->coeffs[i+6] = (a[2] >> 2) & 7;\
    r->coeffs[i+7] = (a[2] >> 5);\
    a += 3;\
    DECOMPRESS_SUB_BLOCK(0, i);\
    DECOMPRESS_SUB_BLOCK(1, i);\
    DECOMPRESS_SUB_BLOCK(2, i);\
    DECOMPRESS_SUB_BLOCK(3, i);\
    DECOMPRESS_SUB_BLOCK(4, i);\
    DECOMPRESS_SUB_BLOCK(5, i);\
    DECOMPRESS_SUB_BLOCK(6, i);\
    DECOMPRESS_SUB_BLOCK(7, i);\
} while(0)


void poly_decompress(poly *r, const unsigned char *a)
{
  DECOMPRESS_BLOCK(0);
  DECOMPRESS_BLOCK(8);
  DECOMPRESS_BLOCK(16);
  DECOMPRESS_BLOCK(24);
  DECOMPRESS_BLOCK(32);
  DECOMPRESS_BLOCK(40);
  DECOMPRESS_BLOCK(48);
  DECOMPRESS_BLOCK(56);
  DECOMPRESS_BLOCK(64);
  DECOMPRESS_BLOCK(72);
  DECOMPRESS_BLOCK(80);
  DECOMPRESS_BLOCK(88);
  DECOMPRESS_BLOCK(96);
  DECOMPRESS_BLOCK(104);
  DECOMPRESS_BLOCK(112);
  DECOMPRESS_BLOCK(120);
  DECOMPRESS_BLOCK(128);
  DECOMPRESS_BLOCK(136);
  DECOMPRESS_BLOCK(144);
  DECOMPRESS_BLOCK(152);
  DECOMPRESS_BLOCK(160);
  DECOMPRESS_BLOCK(168);
  DECOMPRESS_BLOCK(176);
  DECOMPRESS_BLOCK(184);
  DECOMPRESS_BLOCK(192);
  DECOMPRESS_BLOCK(200);
  DECOMPRESS_BLOCK(208);
  DECOMPRESS_BLOCK(216);
  DECOMPRESS_BLOCK(224);
  DECOMPRESS_BLOCK(232);
  DECOMPRESS_BLOCK(240);
  DECOMPRESS_BLOCK(248);
  DECOMPRESS_BLOCK(256);
  DECOMPRESS_BLOCK(264);
  DECOMPRESS_BLOCK(272);
  DECOMPRESS_BLOCK(280);
  DECOMPRESS_BLOCK(288);
  DECOMPRESS_BLOCK(296);
  DECOMPRESS_BLOCK(304);
  DECOMPRESS_BLOCK(312);
  DECOMPRESS_BLOCK(320);
  DECOMPRESS_BLOCK(328);
  DECOMPRESS_BLOCK(336);
  DECOMPRESS_BLOCK(344);
  DECOMPRESS_BLOCK(352);
  DECOMPRESS_BLOCK(360);
  DECOMPRESS_BLOCK(368);
  DECOMPRESS_BLOCK(376);
  DECOMPRESS_BLOCK(384);
  DECOMPRESS_BLOCK(392);
  DECOMPRESS_BLOCK(400);
  DECOMPRESS_BLOCK(408);
  DECOMPRESS_BLOCK(416);
  DECOMPRESS_BLOCK(424);
  DECOMPRESS_BLOCK(432);
  DECOMPRESS_BLOCK(440);
  DECOMPRESS_BLOCK(448);
  DECOMPRESS_BLOCK(456);
  DECOMPRESS_BLOCK(464);
  DECOMPRESS_BLOCK(472);
  DECOMPRESS_BLOCK(480);
  DECOMPRESS_BLOCK(488);
  DECOMPRESS_BLOCK(496);
  DECOMPRESS_BLOCK(504);
  DECOMPRESS_BLOCK(512);
  DECOMPRESS_BLOCK(520);
  DECOMPRESS_BLOCK(528);
  DECOMPRESS_BLOCK(536);
  DECOMPRESS_BLOCK(544);
  DECOMPRESS_BLOCK(552);
  DECOMPRESS_BLOCK(560);
  DECOMPRESS_BLOCK(568);
  DECOMPRESS_BLOCK(576);
  DECOMPRESS_BLOCK(584);
  DECOMPRESS_BLOCK(592);
  DECOMPRESS_BLOCK(600);
  DECOMPRESS_BLOCK(608);
  DECOMPRESS_BLOCK(616);
  DECOMPRESS_BLOCK(624);
  DECOMPRESS_BLOCK(632);
  DECOMPRESS_BLOCK(640);
  DECOMPRESS_BLOCK(648);
  DECOMPRESS_BLOCK(656);
  DECOMPRESS_BLOCK(664);
  DECOMPRESS_BLOCK(672);
  DECOMPRESS_BLOCK(680);
  DECOMPRESS_BLOCK(688);
  DECOMPRESS_BLOCK(696);
  DECOMPRESS_BLOCK(704);
  DECOMPRESS_BLOCK(712);
  DECOMPRESS_BLOCK(720);
  DECOMPRESS_BLOCK(728);
  DECOMPRESS_BLOCK(736);
  DECOMPRESS_BLOCK(744);
  DECOMPRESS_BLOCK(752);
  DECOMPRESS_BLOCK(760);
  DECOMPRESS_BLOCK(768);
  DECOMPRESS_BLOCK(776);
  DECOMPRESS_BLOCK(784);
  DECOMPRESS_BLOCK(792);
  DECOMPRESS_BLOCK(800);
  DECOMPRESS_BLOCK(808);
  DECOMPRESS_BLOCK(816);
  DECOMPRESS_BLOCK(824);
  DECOMPRESS_BLOCK(832);
  DECOMPRESS_BLOCK(840);
  DECOMPRESS_BLOCK(848);
  DECOMPRESS_BLOCK(856);
  DECOMPRESS_BLOCK(864);
  DECOMPRESS_BLOCK(872);
  DECOMPRESS_BLOCK(880);
  DECOMPRESS_BLOCK(888);
  DECOMPRESS_BLOCK(896);
  DECOMPRESS_BLOCK(904);
  DECOMPRESS_BLOCK(912);
  DECOMPRESS_BLOCK(920);
  DECOMPRESS_BLOCK(928);
  DECOMPRESS_BLOCK(936);
  DECOMPRESS_BLOCK(944);
  DECOMPRESS_BLOCK(952);
  DECOMPRESS_BLOCK(960);
  DECOMPRESS_BLOCK(968);
  DECOMPRESS_BLOCK(976);
  DECOMPRESS_BLOCK(984);
  DECOMPRESS_BLOCK(992);
  DECOMPRESS_BLOCK(1000);
  DECOMPRESS_BLOCK(1008);
  DECOMPRESS_BLOCK(1016);
}

#define FROM_SUB_BLOCK(j, i) do {\
      mask = -((msg[i] >> j)&1);\
      r->coeffs[8*i+j+  0] = mask & (NEWHOPE_Q/2);\
      r->coeffs[8*i+j+256] = mask & (NEWHOPE_Q/2);\
      r->coeffs[8*i+j+512] = mask & (NEWHOPE_Q/2);\
      r->coeffs[8*i+j+768] = mask & (NEWHOPE_Q/2);\
} while(0)

void poly_frommsg(poly *r, const unsigned char *msg)
{
  unsigned int i,j,mask;
  
  FROM_SUB_BLOCK(0, 0);
  FROM_SUB_BLOCK(1, 0);
  FROM_SUB_BLOCK(2, 0);
  FROM_SUB_BLOCK(3, 0);
  FROM_SUB_BLOCK(4, 0);
  FROM_SUB_BLOCK(5, 0);
  FROM_SUB_BLOCK(6, 0);
  FROM_SUB_BLOCK(7, 0);
  FROM_SUB_BLOCK(0, 1);
  FROM_SUB_BLOCK(1, 1);
  FROM_SUB_BLOCK(2, 1);
  FROM_SUB_BLOCK(3, 1);
  FROM_SUB_BLOCK(4, 1);
  FROM_SUB_BLOCK(5, 1);
  FROM_SUB_BLOCK(6, 1);
  FROM_SUB_BLOCK(7, 1);
  FROM_SUB_BLOCK(0, 2);
  FROM_SUB_BLOCK(1, 2);
  FROM_SUB_BLOCK(2, 2);
  FROM_SUB_BLOCK(3, 2);
  FROM_SUB_BLOCK(4, 2);
  FROM_SUB_BLOCK(5, 2);
  FROM_SUB_BLOCK(6, 2);
  FROM_SUB_BLOCK(7, 2);
  FROM_SUB_BLOCK(0, 3);
  FROM_SUB_BLOCK(1, 3);
  FROM_SUB_BLOCK(2, 3);
  FROM_SUB_BLOCK(3, 3);
  FROM_SUB_BLOCK(4, 3);
  FROM_SUB_BLOCK(5, 3);
  FROM_SUB_BLOCK(6, 3);
  FROM_SUB_BLOCK(7, 3);
  FROM_SUB_BLOCK(0, 4);
  FROM_SUB_BLOCK(1, 4);
  FROM_SUB_BLOCK(2, 4);
  FROM_SUB_BLOCK(3, 4);
  FROM_SUB_BLOCK(4, 4);
  FROM_SUB_BLOCK(5, 4);
  FROM_SUB_BLOCK(6, 4);
  FROM_SUB_BLOCK(7, 4);
  FROM_SUB_BLOCK(0, 5);
  FROM_SUB_BLOCK(1, 5);
  FROM_SUB_BLOCK(2, 5);
  FROM_SUB_BLOCK(3, 5);
  FROM_SUB_BLOCK(4, 5);
  FROM_SUB_BLOCK(5, 5);
  FROM_SUB_BLOCK(6, 5);
  FROM_SUB_BLOCK(7, 5);
  FROM_SUB_BLOCK(0, 6);
  FROM_SUB_BLOCK(1, 6);
  FROM_SUB_BLOCK(2, 6);
  FROM_SUB_BLOCK(3, 6);
  FROM_SUB_BLOCK(4, 6);
  FROM_SUB_BLOCK(5, 6);
  FROM_SUB_BLOCK(6, 6);
  FROM_SUB_BLOCK(7, 6);
  FROM_SUB_BLOCK(0, 7);
  FROM_SUB_BLOCK(1, 7);
  FROM_SUB_BLOCK(2, 7);
  FROM_SUB_BLOCK(3, 7);
  FROM_SUB_BLOCK(4, 7);
  FROM_SUB_BLOCK(5, 7);
  FROM_SUB_BLOCK(6, 7);
  FROM_SUB_BLOCK(7, 7);
  FROM_SUB_BLOCK(0, 8);
  FROM_SUB_BLOCK(1, 8);
  FROM_SUB_BLOCK(2, 8);
  FROM_SUB_BLOCK(3, 8);
  FROM_SUB_BLOCK(4, 8);
  FROM_SUB_BLOCK(5, 8);
  FROM_SUB_BLOCK(6, 8);
  FROM_SUB_BLOCK(7, 8);
  FROM_SUB_BLOCK(0, 9);
  FROM_SUB_BLOCK(1, 9);
  FROM_SUB_BLOCK(2, 9);
  FROM_SUB_BLOCK(3, 9);
  FROM_SUB_BLOCK(4, 9);
  FROM_SUB_BLOCK(5, 9);
  FROM_SUB_BLOCK(6, 9);
  FROM_SUB_BLOCK(7, 9);
  FROM_SUB_BLOCK(0, 10);
  FROM_SUB_BLOCK(1, 10);
  FROM_SUB_BLOCK(2, 10);
  FROM_SUB_BLOCK(3, 10);
  FROM_SUB_BLOCK(4, 10);
  FROM_SUB_BLOCK(5, 10);
  FROM_SUB_BLOCK(6, 10);
  FROM_SUB_BLOCK(7, 10);
  FROM_SUB_BLOCK(0, 11);
  FROM_SUB_BLOCK(1, 11);
  FROM_SUB_BLOCK(2, 11);
  FROM_SUB_BLOCK(3, 11);
  FROM_SUB_BLOCK(4, 11);
  FROM_SUB_BLOCK(5, 11);
  FROM_SUB_BLOCK(6, 11);
  FROM_SUB_BLOCK(7, 11);
  FROM_SUB_BLOCK(0, 12);
  FROM_SUB_BLOCK(1, 12);
  FROM_SUB_BLOCK(2, 12);
  FROM_SUB_BLOCK(3, 12);
  FROM_SUB_BLOCK(4, 12);
  FROM_SUB_BLOCK(5, 12);
  FROM_SUB_BLOCK(6, 12);
  FROM_SUB_BLOCK(7, 12);
  FROM_SUB_BLOCK(0, 13);
  FROM_SUB_BLOCK(1, 13);
  FROM_SUB_BLOCK(2, 13);
  FROM_SUB_BLOCK(3, 13);
  FROM_SUB_BLOCK(4, 13);
  FROM_SUB_BLOCK(5, 13);
  FROM_SUB_BLOCK(6, 13);
  FROM_SUB_BLOCK(7, 13);
  FROM_SUB_BLOCK(0, 14);
  FROM_SUB_BLOCK(1, 14);
  FROM_SUB_BLOCK(2, 14);
  FROM_SUB_BLOCK(3, 14);
  FROM_SUB_BLOCK(4, 14);
  FROM_SUB_BLOCK(5, 14);
  FROM_SUB_BLOCK(6, 14);
  FROM_SUB_BLOCK(7, 14);
  FROM_SUB_BLOCK(0, 15);
  FROM_SUB_BLOCK(1, 15);
  FROM_SUB_BLOCK(2, 15);
  FROM_SUB_BLOCK(3, 15);
  FROM_SUB_BLOCK(4, 15);
  FROM_SUB_BLOCK(5, 15);
  FROM_SUB_BLOCK(6, 15);
  FROM_SUB_BLOCK(7, 15);
  FROM_SUB_BLOCK(0, 16);
  FROM_SUB_BLOCK(1, 16);
  FROM_SUB_BLOCK(2, 16);
  FROM_SUB_BLOCK(3, 16);
  FROM_SUB_BLOCK(4, 16);
  FROM_SUB_BLOCK(5, 16);
  FROM_SUB_BLOCK(6, 16);
  FROM_SUB_BLOCK(7, 16);
  FROM_SUB_BLOCK(0, 17);
  FROM_SUB_BLOCK(1, 17);
  FROM_SUB_BLOCK(2, 17);
  FROM_SUB_BLOCK(3, 17);
  FROM_SUB_BLOCK(4, 17);
  FROM_SUB_BLOCK(5, 17);
  FROM_SUB_BLOCK(6, 17);
  FROM_SUB_BLOCK(7, 17);
  FROM_SUB_BLOCK(0, 18);
  FROM_SUB_BLOCK(1, 18);
  FROM_SUB_BLOCK(2, 18);
  FROM_SUB_BLOCK(3, 18);
  FROM_SUB_BLOCK(4, 18);
  FROM_SUB_BLOCK(5, 18);
  FROM_SUB_BLOCK(6, 18);
  FROM_SUB_BLOCK(7, 18);
  FROM_SUB_BLOCK(0, 19);
  FROM_SUB_BLOCK(1, 19);
  FROM_SUB_BLOCK(2, 19);
  FROM_SUB_BLOCK(3, 19);
  FROM_SUB_BLOCK(4, 19);
  FROM_SUB_BLOCK(5, 19);
  FROM_SUB_BLOCK(6, 19);
  FROM_SUB_BLOCK(7, 19);
  FROM_SUB_BLOCK(0, 20);
  FROM_SUB_BLOCK(1, 20);
  FROM_SUB_BLOCK(2, 20);
  FROM_SUB_BLOCK(3, 20);
  FROM_SUB_BLOCK(4, 20);
  FROM_SUB_BLOCK(5, 20);
  FROM_SUB_BLOCK(6, 20);
  FROM_SUB_BLOCK(7, 20);
  FROM_SUB_BLOCK(0, 21);
  FROM_SUB_BLOCK(1, 21);
  FROM_SUB_BLOCK(2, 21);
  FROM_SUB_BLOCK(3, 21);
  FROM_SUB_BLOCK(4, 21);
  FROM_SUB_BLOCK(5, 21);
  FROM_SUB_BLOCK(6, 21);
  FROM_SUB_BLOCK(7, 21);
  FROM_SUB_BLOCK(0, 22);
  FROM_SUB_BLOCK(1, 22);
  FROM_SUB_BLOCK(2, 22);
  FROM_SUB_BLOCK(3, 22);
  FROM_SUB_BLOCK(4, 22);
  FROM_SUB_BLOCK(5, 22);
  FROM_SUB_BLOCK(6, 22);
  FROM_SUB_BLOCK(7, 22);
  FROM_SUB_BLOCK(0, 23);
  FROM_SUB_BLOCK(1, 23);
  FROM_SUB_BLOCK(2, 23);
  FROM_SUB_BLOCK(3, 23);
  FROM_SUB_BLOCK(4, 23);
  FROM_SUB_BLOCK(5, 23);
  FROM_SUB_BLOCK(6, 23);
  FROM_SUB_BLOCK(7, 23);
  FROM_SUB_BLOCK(0, 24);
  FROM_SUB_BLOCK(1, 24);
  FROM_SUB_BLOCK(2, 24);
  FROM_SUB_BLOCK(3, 24);
  FROM_SUB_BLOCK(4, 24);
  FROM_SUB_BLOCK(5, 24);
  FROM_SUB_BLOCK(6, 24);
  FROM_SUB_BLOCK(7, 24);
  FROM_SUB_BLOCK(0, 25);
  FROM_SUB_BLOCK(1, 25);
  FROM_SUB_BLOCK(2, 25);
  FROM_SUB_BLOCK(3, 25);
  FROM_SUB_BLOCK(4, 25);
  FROM_SUB_BLOCK(5, 25);
  FROM_SUB_BLOCK(6, 25);
  FROM_SUB_BLOCK(7, 25);
  FROM_SUB_BLOCK(0, 26);
  FROM_SUB_BLOCK(1, 26);
  FROM_SUB_BLOCK(2, 26);
  FROM_SUB_BLOCK(3, 26);
  FROM_SUB_BLOCK(4, 26);
  FROM_SUB_BLOCK(5, 26);
  FROM_SUB_BLOCK(6, 26);
  FROM_SUB_BLOCK(7, 26);
  FROM_SUB_BLOCK(0, 27);
  FROM_SUB_BLOCK(1, 27);
  FROM_SUB_BLOCK(2, 27);
  FROM_SUB_BLOCK(3, 27);
  FROM_SUB_BLOCK(4, 27);
  FROM_SUB_BLOCK(5, 27);
  FROM_SUB_BLOCK(6, 27);
  FROM_SUB_BLOCK(7, 27);
  FROM_SUB_BLOCK(0, 28);
  FROM_SUB_BLOCK(1, 28);
  FROM_SUB_BLOCK(2, 28);
  FROM_SUB_BLOCK(3, 28);
  FROM_SUB_BLOCK(4, 28);
  FROM_SUB_BLOCK(5, 28);
  FROM_SUB_BLOCK(6, 28);
  FROM_SUB_BLOCK(7, 28);
  FROM_SUB_BLOCK(0, 29);
  FROM_SUB_BLOCK(1, 29);
  FROM_SUB_BLOCK(2, 29);
  FROM_SUB_BLOCK(3, 29);
  FROM_SUB_BLOCK(4, 29);
  FROM_SUB_BLOCK(5, 29);
  FROM_SUB_BLOCK(6, 29);
  FROM_SUB_BLOCK(7, 29);
  FROM_SUB_BLOCK(0, 30);
  FROM_SUB_BLOCK(1, 30);
  FROM_SUB_BLOCK(2, 30);
  FROM_SUB_BLOCK(3, 30);
  FROM_SUB_BLOCK(4, 30);
  FROM_SUB_BLOCK(5, 30);
  FROM_SUB_BLOCK(6, 30);
  FROM_SUB_BLOCK(7, 30);
  FROM_SUB_BLOCK(0, 31);
  FROM_SUB_BLOCK(1, 31);
  FROM_SUB_BLOCK(2, 31);
  FROM_SUB_BLOCK(3, 31);
  FROM_SUB_BLOCK(4, 31);
  FROM_SUB_BLOCK(5, 31);
  FROM_SUB_BLOCK(6, 31);
  FROM_SUB_BLOCK(7, 31);
}

#define TO_MSG_BLOCK(i) do {\
  x2 = x->coeffs[i+  0];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t = t2 ^ m;\
  x2 = x->coeffs[i+256];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t += t2 ^ m;\
  x2 = x->coeffs[i+512];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t += t2 ^ m;\
  x2 = x->coeffs[i+768];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t += t2 ^ m;\
    t = ((t - NEWHOPE_Q));\
    t >>= 15;\
    msg[i>>3] |= t<<(i&7);\
} while(0)

void poly_tomsg(unsigned char *msg, const poly *x)
{
  unsigned int i;
  uint16_t t, x2;
  int16_t r,m, t2;
  int16_t c;
  uint32_t u;


  msg[0] = 0;
  msg[1] = 0;
  msg[2] = 0;
  msg[3] = 0;
  msg[4] = 0;
  msg[5] = 0;
  msg[6] = 0;
  msg[7] = 0;
  msg[8] = 0;
  msg[9] = 0;
  msg[10] = 0;
  msg[11] = 0;
  msg[12] = 0;
  msg[13] = 0;
  msg[14] = 0;
  msg[15] = 0;
  msg[16] = 0;
  msg[17] = 0;
  msg[18] = 0;
  msg[19] = 0;
  msg[20] = 0;
  msg[21] = 0;
  msg[22] = 0;
  msg[23] = 0;
  msg[24] = 0;
  msg[25] = 0;
  msg[26] = 0;
  msg[27] = 0;
  msg[28] = 0;
  msg[29] = 0;
  msg[30] = 0;
  msg[31] = 0;
  
  TO_MSG_BLOCK(0);
  TO_MSG_BLOCK(1);
  TO_MSG_BLOCK(2);
  TO_MSG_BLOCK(3);
  TO_MSG_BLOCK(4);
  TO_MSG_BLOCK(5);
  TO_MSG_BLOCK(6);
  TO_MSG_BLOCK(7);
  TO_MSG_BLOCK(8);
  TO_MSG_BLOCK(9);
  TO_MSG_BLOCK(10);
  TO_MSG_BLOCK(11);
  TO_MSG_BLOCK(12);
  TO_MSG_BLOCK(13);
  TO_MSG_BLOCK(14);
  TO_MSG_BLOCK(15);
  TO_MSG_BLOCK(16);
  TO_MSG_BLOCK(17);
  TO_MSG_BLOCK(18);
  TO_MSG_BLOCK(19);
  TO_MSG_BLOCK(20);
  TO_MSG_BLOCK(21);
  TO_MSG_BLOCK(22);
  TO_MSG_BLOCK(23);
  TO_MSG_BLOCK(24);
  TO_MSG_BLOCK(25);
  TO_MSG_BLOCK(26);
  TO_MSG_BLOCK(27);
  TO_MSG_BLOCK(28);
  TO_MSG_BLOCK(29);
  TO_MSG_BLOCK(30);
  TO_MSG_BLOCK(31);
  TO_MSG_BLOCK(32);
  TO_MSG_BLOCK(33);
  TO_MSG_BLOCK(34);
  TO_MSG_BLOCK(35);
  TO_MSG_BLOCK(36);
  TO_MSG_BLOCK(37);
  TO_MSG_BLOCK(38);
  TO_MSG_BLOCK(39);
  TO_MSG_BLOCK(40);
  TO_MSG_BLOCK(41);
  TO_MSG_BLOCK(42);
  TO_MSG_BLOCK(43);
  TO_MSG_BLOCK(44);
  TO_MSG_BLOCK(45);
  TO_MSG_BLOCK(46);
  TO_MSG_BLOCK(47);
  TO_MSG_BLOCK(48);
  TO_MSG_BLOCK(49);
  TO_MSG_BLOCK(50);
  TO_MSG_BLOCK(51);
  TO_MSG_BLOCK(52);
  TO_MSG_BLOCK(53);
  TO_MSG_BLOCK(54);
  TO_MSG_BLOCK(55);
  TO_MSG_BLOCK(56);
  TO_MSG_BLOCK(57);
  TO_MSG_BLOCK(58);
  TO_MSG_BLOCK(59);
  TO_MSG_BLOCK(60);
  TO_MSG_BLOCK(61);
  TO_MSG_BLOCK(62);
  TO_MSG_BLOCK(63);
  TO_MSG_BLOCK(64);
  TO_MSG_BLOCK(65);
  TO_MSG_BLOCK(66);
  TO_MSG_BLOCK(67);
  TO_MSG_BLOCK(68);
  TO_MSG_BLOCK(69);
  TO_MSG_BLOCK(70);
  TO_MSG_BLOCK(71);
  TO_MSG_BLOCK(72);
  TO_MSG_BLOCK(73);
  TO_MSG_BLOCK(74);
  TO_MSG_BLOCK(75);
  TO_MSG_BLOCK(76);
  TO_MSG_BLOCK(77);
  TO_MSG_BLOCK(78);
  TO_MSG_BLOCK(79);
  TO_MSG_BLOCK(80);
  TO_MSG_BLOCK(81);
  TO_MSG_BLOCK(82);
  TO_MSG_BLOCK(83);
  TO_MSG_BLOCK(84);
  TO_MSG_BLOCK(85);
  TO_MSG_BLOCK(86);
  TO_MSG_BLOCK(87);
  TO_MSG_BLOCK(88);
  TO_MSG_BLOCK(89);
  TO_MSG_BLOCK(90);
  TO_MSG_BLOCK(91);
  TO_MSG_BLOCK(92);
  TO_MSG_BLOCK(93);
  TO_MSG_BLOCK(94);
  TO_MSG_BLOCK(95);
  TO_MSG_BLOCK(96);
  TO_MSG_BLOCK(97);
  TO_MSG_BLOCK(98);
  TO_MSG_BLOCK(99);
  TO_MSG_BLOCK(100);
  TO_MSG_BLOCK(101);
  TO_MSG_BLOCK(102);
  TO_MSG_BLOCK(103);
  TO_MSG_BLOCK(104);
  TO_MSG_BLOCK(105);
  TO_MSG_BLOCK(106);
  TO_MSG_BLOCK(107);
  TO_MSG_BLOCK(108);
  TO_MSG_BLOCK(109);
  TO_MSG_BLOCK(110);
  TO_MSG_BLOCK(111);
  TO_MSG_BLOCK(112);
  TO_MSG_BLOCK(113);
  TO_MSG_BLOCK(114);
  TO_MSG_BLOCK(115);
  TO_MSG_BLOCK(116);
  TO_MSG_BLOCK(117);
  TO_MSG_BLOCK(118);
  TO_MSG_BLOCK(119);
  TO_MSG_BLOCK(120);
  TO_MSG_BLOCK(121);
  TO_MSG_BLOCK(122);
  TO_MSG_BLOCK(123);
  TO_MSG_BLOCK(124);
  TO_MSG_BLOCK(125);
  TO_MSG_BLOCK(126);
  TO_MSG_BLOCK(127);
  TO_MSG_BLOCK(128);
  TO_MSG_BLOCK(129);
  TO_MSG_BLOCK(130);
  TO_MSG_BLOCK(131);
  TO_MSG_BLOCK(132);
  TO_MSG_BLOCK(133);
  TO_MSG_BLOCK(134);
  TO_MSG_BLOCK(135);
  TO_MSG_BLOCK(136);
  TO_MSG_BLOCK(137);
  TO_MSG_BLOCK(138);
  TO_MSG_BLOCK(139);
  TO_MSG_BLOCK(140);
  TO_MSG_BLOCK(141);
  TO_MSG_BLOCK(142);
  TO_MSG_BLOCK(143);
  TO_MSG_BLOCK(144);
  TO_MSG_BLOCK(145);
  TO_MSG_BLOCK(146);
  TO_MSG_BLOCK(147);
  TO_MSG_BLOCK(148);
  TO_MSG_BLOCK(149);
  TO_MSG_BLOCK(150);
  TO_MSG_BLOCK(151);
  TO_MSG_BLOCK(152);
  TO_MSG_BLOCK(153);
  TO_MSG_BLOCK(154);
  TO_MSG_BLOCK(155);
  TO_MSG_BLOCK(156);
  TO_MSG_BLOCK(157);
  TO_MSG_BLOCK(158);
  TO_MSG_BLOCK(159);
  TO_MSG_BLOCK(160);
  TO_MSG_BLOCK(161);
  TO_MSG_BLOCK(162);
  TO_MSG_BLOCK(163);
  TO_MSG_BLOCK(164);
  TO_MSG_BLOCK(165);
  TO_MSG_BLOCK(166);
  TO_MSG_BLOCK(167);
  TO_MSG_BLOCK(168);
  TO_MSG_BLOCK(169);
  TO_MSG_BLOCK(170);
  TO_MSG_BLOCK(171);
  TO_MSG_BLOCK(172);
  TO_MSG_BLOCK(173);
  TO_MSG_BLOCK(174);
  TO_MSG_BLOCK(175);
  TO_MSG_BLOCK(176);
  TO_MSG_BLOCK(177);
  TO_MSG_BLOCK(178);
  TO_MSG_BLOCK(179);
  TO_MSG_BLOCK(180);
  TO_MSG_BLOCK(181);
  TO_MSG_BLOCK(182);
  TO_MSG_BLOCK(183);
  TO_MSG_BLOCK(184);
  TO_MSG_BLOCK(185);
  TO_MSG_BLOCK(186);
  TO_MSG_BLOCK(187);
  TO_MSG_BLOCK(188);
  TO_MSG_BLOCK(189);
  TO_MSG_BLOCK(190);
  TO_MSG_BLOCK(191);
  TO_MSG_BLOCK(192);
  TO_MSG_BLOCK(193);
  TO_MSG_BLOCK(194);
  TO_MSG_BLOCK(195);
  TO_MSG_BLOCK(196);
  TO_MSG_BLOCK(197);
  TO_MSG_BLOCK(198);
  TO_MSG_BLOCK(199);
  TO_MSG_BLOCK(200);
  TO_MSG_BLOCK(201);
  TO_MSG_BLOCK(202);
  TO_MSG_BLOCK(203);
  TO_MSG_BLOCK(204);
  TO_MSG_BLOCK(205);
  TO_MSG_BLOCK(206);
  TO_MSG_BLOCK(207);
  TO_MSG_BLOCK(208);
  TO_MSG_BLOCK(209);
  TO_MSG_BLOCK(210);
  TO_MSG_BLOCK(211);
  TO_MSG_BLOCK(212);
  TO_MSG_BLOCK(213);
  TO_MSG_BLOCK(214);
  TO_MSG_BLOCK(215);
  TO_MSG_BLOCK(216);
  TO_MSG_BLOCK(217);
  TO_MSG_BLOCK(218);
  TO_MSG_BLOCK(219);
  TO_MSG_BLOCK(220);
  TO_MSG_BLOCK(221);
  TO_MSG_BLOCK(222);
  TO_MSG_BLOCK(223);
  TO_MSG_BLOCK(224);
  TO_MSG_BLOCK(225);
  TO_MSG_BLOCK(226);
  TO_MSG_BLOCK(227);
  TO_MSG_BLOCK(228);
  TO_MSG_BLOCK(229);
  TO_MSG_BLOCK(230);
  TO_MSG_BLOCK(231);
  TO_MSG_BLOCK(232);
  TO_MSG_BLOCK(233);
  TO_MSG_BLOCK(234);
  TO_MSG_BLOCK(235);
  TO_MSG_BLOCK(236);
  TO_MSG_BLOCK(237);
  TO_MSG_BLOCK(238);
  TO_MSG_BLOCK(239);
  TO_MSG_BLOCK(240);
  TO_MSG_BLOCK(241);
  TO_MSG_BLOCK(242);
  TO_MSG_BLOCK(243);
  TO_MSG_BLOCK(244);
  TO_MSG_BLOCK(245);
  TO_MSG_BLOCK(246);
  TO_MSG_BLOCK(247);
  TO_MSG_BLOCK(248);
  TO_MSG_BLOCK(249);
  TO_MSG_BLOCK(250);
  TO_MSG_BLOCK(251);
  TO_MSG_BLOCK(252);
  TO_MSG_BLOCK(253);
  TO_MSG_BLOCK(254);
  TO_MSG_BLOCK(255);
}

#define UNIFORM_BLOCK(i) do {\
    ctr = 0;\
    extseed[NEWHOPE_SYMBYTES] = i;\
    shake128_absorb(state, extseed, NEWHOPE_SYMBYTES+1);\
    while(ctr < 64) {\
      shake128_squeezeblocks(buf,1,state);\
      for(j=0;j<SHAKE128_RATE && ctr < 64;j+=2){\
        val = (buf[j] | ((uint16_t) buf[j+1] << 8));\
        if(val < 5*NEWHOPE_Q){\
          a->coeffs[i*64+ctr] = val;\
          ctr++;\
        }\
      }\
    }\
} while(0)

void poly_uniform(poly *a, const unsigned char *seed)
{
  unsigned int ctr=0;
  uint16_t val;
  uint64_t state[25];
  uint8_t buf[SHAKE128_RATE];
  uint8_t extseed[NEWHOPE_SYMBYTES+1];
  int i,j;

  extseed[0] = seed[0];
  extseed[1] = seed[1];
  extseed[2] = seed[2];
  extseed[3] = seed[3];
  extseed[4] = seed[4];
  extseed[5] = seed[5];
  extseed[6] = seed[6];
  extseed[7] = seed[7];
  extseed[8] = seed[8];
  extseed[9] = seed[9];
  extseed[10] = seed[10];
  extseed[11] = seed[11];
  extseed[12] = seed[12];
  extseed[13] = seed[13];
  extseed[14] = seed[14];
  extseed[15] = seed[15];
  extseed[16] = seed[16];
  extseed[17] = seed[17];
  extseed[18] = seed[18];
  extseed[19] = seed[19];
  extseed[20] = seed[20];
  extseed[21] = seed[21];
  extseed[22] = seed[22];
  extseed[23] = seed[23];
  extseed[24] = seed[24];
  extseed[25] = seed[25];
  extseed[26] = seed[26];
  extseed[27] = seed[27];
  extseed[28] = seed[28];
  extseed[29] = seed[29];
  extseed[30] = seed[30];
  extseed[31] = seed[31];

  UNIFORM_BLOCK(0);
  UNIFORM_BLOCK(1);
  UNIFORM_BLOCK(2);
  UNIFORM_BLOCK(3);
  UNIFORM_BLOCK(4);
  UNIFORM_BLOCK(5);
  UNIFORM_BLOCK(6);
  UNIFORM_BLOCK(7);
  UNIFORM_BLOCK(8);
  UNIFORM_BLOCK(9);
  UNIFORM_BLOCK(10);
  UNIFORM_BLOCK(11);
  UNIFORM_BLOCK(12);
  UNIFORM_BLOCK(13);
  UNIFORM_BLOCK(14);
  UNIFORM_BLOCK(15);
}

#define SAMPLE_BLOCK(i) do{\
      extseed[NEWHOPE_SYMBYTES+1] = i;\
    shake256(buf,128,  extseed,NEWHOPE_SYMBYTES+2);\
    for(j=0;j<128;j+=4)\
    {\
      t = buf[j] | ((uint32_t)buf[j+1] << 8) | ((uint32_t)buf[j+2] << 16) | ((uint32_t)buf[j+3] << 24);\
      d = 0;\
      for(k=0;k<8;k++)\
        d += (t >> k) & 0x01010101;\
      a = d & 0xff;\
      b = ((d >>  8) & 0xff);\
      c = ((d >> 16) & 0xff);\
      d >>= 24;\
      r->coeffs[64*i+j/2]   = a + NEWHOPE_Q - b;\
      r->coeffs[64*i+j/2+1] = c + NEWHOPE_Q - d;\
    }\
} while(0)

void poly_sample(poly *r, const unsigned char *seed, unsigned char nonce)
{
#if NEWHOPE_K != 8
#error "poly_getnoise in poly.c only supports k=8"
#endif
  unsigned char buf[128];
  uint32_t t, d, a, b, c;
  int i,j,k;

  unsigned char   extseed[NEWHOPE_SYMBYTES+2];

  extseed[0] = seed[0];
  extseed[1] = seed[1];
  extseed[2] = seed[2];
  extseed[3] = seed[3];
  extseed[4] = seed[4];
  extseed[5] = seed[5];
  extseed[6] = seed[6];
  extseed[7] = seed[7];
  extseed[8] = seed[8];
  extseed[9] = seed[9];
  extseed[10] = seed[10];
  extseed[11] = seed[11];
  extseed[12] = seed[12];
  extseed[13] = seed[13];
  extseed[14] = seed[14];
  extseed[15] = seed[15];
  extseed[16] = seed[16];
  extseed[17] = seed[17];
  extseed[18] = seed[18];
  extseed[19] = seed[19];
  extseed[20] = seed[20];
  extseed[21] = seed[21];
  extseed[22] = seed[22];
  extseed[23] = seed[23];
  extseed[24] = seed[24];
  extseed[25] = seed[25];
  extseed[26] = seed[26];
  extseed[27] = seed[27];
  extseed[28] = seed[28];
  extseed[29] = seed[29];
  extseed[30] = seed[30];
  extseed[31] = seed[31];

  extseed[NEWHOPE_SYMBYTES] = nonce;

  SAMPLE_BLOCK(0);
  SAMPLE_BLOCK(1);
  SAMPLE_BLOCK(2);
  SAMPLE_BLOCK(3);
  SAMPLE_BLOCK(4);
  SAMPLE_BLOCK(5);
  SAMPLE_BLOCK(6);
  SAMPLE_BLOCK(7);
  SAMPLE_BLOCK(8);
  SAMPLE_BLOCK(9);
  SAMPLE_BLOCK(10);
  SAMPLE_BLOCK(11);
  SAMPLE_BLOCK(12);
  SAMPLE_BLOCK(13);
  SAMPLE_BLOCK(14);
  SAMPLE_BLOCK(15);
}
