#include "poly.h"
#include "ntt.h"
#include "../common/randombytes.h"
#include "../common/reduce.h"
#include "../common/fips202.h"

uint16_t omegas_montgomery[NEWHOPE_N/2] = {4075,5315,7965,7373,522,10120,9027,5079,2344,1278,1973,5574,1018,6364,11248,8775,7500,7822,5537,4749,8500,12142,5456,7840,5445,3860,4536,11239,6171,8471,2683,11099,10561,400,6137,7341,5415,8646,6136,5862,5529,5206,56,9090,8724,11635,1702,10302,5339,6843,6093,3710,316,382,11821,8301,10930,5435,11035,973,8291,10256,8410,1922,12097,10968,10240,4912,4698,5057,7509,8844,8807,11502,5468,1010,9162,8120,2920,5241,6055,8953,677,5874,2766,10966,12237,9115,12138,10162,3957,2839,6383,2505,11858,1579,9026,3600,6077,4624,11868,4080,6068,3602,605,9987,504,8076,4782,6403,3029,6695,11184,142,5681,8812,2844,3438,8077,975,58,12048,1003,8757,885,6281,1956,5009,12225,3656,11606,9830,1566,5782,2503,2948,7032,3834,5919,4433,3054,6803,9166,1747,10211,11177,4322,1958,922,11848,4079,11231,4046,11580,1319,9139,6224,835,8049,8719,7105,1200,6122,9734,3956,1360,6119,5297,4298,3329,168,2692,1594,10327,5106,6328,3728,8240,5990,11130,948,1146,10885,325,8212,4016,8527,2919,295,6190,652,5766,11713,8326,6142,2447,1805,2882,10238,1954,1843,9928,4115,3030,2908,12071,8760,3434,5876,2281,2031,5333,8298,8320,12133,2767,11836,5908,11871,8517,6860,7515,10996,4737,2500,10800,5942,1583,11026,12240,5915,10806,1815,5383,1512,11939,2057,6920,9087,7796,8974,426,4754,1858,8532,10314,11942,2925,174,11566,3009,1693,2655,6554,5868,2738,};
uint16_t omegas_inv_montgomery[NEWHOPE_N/2] = {4075,6974,4916,4324,7210,3262,2169,11767,3514,1041,5925,11271,6715,10316,11011,9945,1190,9606,3818,6118,1050,7753,8429,6844,4449,6833,147,3789,7540,6752,4467,4789,10367,3879,2033,3998,11316,1254,6854,1359,3988,468,11907,11973,8579,6196,5446,6950,1987,10587,654,3565,3199,12233,7083,6760,6427,6153,3643,6874,4948,6152,11889,1728,7280,10333,6008,11404,3532,11286,241,12231,11314,4212,8851,9445,3477,6608,12147,1105,5594,9260,5886,7507,4213,11785,2302,11684,8687,6221,8209,421,7665,6212,8689,3263,10710,431,9784,5906,9450,8332,2127,151,3174,52,1323,9523,6415,11612,3336,6234,7048,9369,4169,3127,11279,6821,787,3482,3445,4780,7232,7591,7377,2049,1321,192,9551,6421,5735,9634,10596,9280,723,12115,9364,347,1975,3757,10431,7535,11863,3315,4493,3202,5369,10232,350,10777,6906,10474,1483,6374,49,1263,10706,6347,1489,9789,7552,1293,4774,5429,3772,418,6381,453,9522,156,3969,3991,6956,10258,10008,6413,8855,3529,218,9381,9259,8174,2361,10446,10335,2051,9407,10484,9842,6147,3963,576,6523,11637,6099,11994,9370,3762,8273,4077,11964,1404,11143,11341,1159,6299,4049,8561,5961,7183,1962,10695,9597,12121,8960,7991,6992,6170,10929,8333,2555,6167,11089,5184,3570,4240,11454,6065,3150,10970,709,8243,1058,8210,441,11367,10331,7967,1112,2078,10542,3123,5486,9235,7856,6370,8455,5257,9341,9786,6507,10723,2459,683,8633,64,};

uint16_t psis_bitrev_montgomery[NEWHOPE_N] = {4075,5315,7965,7373,522,10120,9027,5079,2344,1278,1973,5574,1018,6364,11248,8775,7500,7822,5537,4749,8500,12142,5456,7840,5445,3860,4536,11239,6171,8471,2683,11099,10561,400,6137,7341,5415,8646,6136,5862,5529,5206,56,9090,8724,11635,1702,10302,5339,6843,6093,3710,316,382,11821,8301,10930,5435,11035,973,8291,10256,8410,1922,12097,10968,10240,4912,4698,5057,7509,8844,8807,11502,5468,1010,9162,8120,2920,5241,6055,8953,677,5874,2766,10966,12237,9115,12138,10162,3957,2839,6383,2505,11858,1579,9026,3600,6077,4624,11868,4080,6068,3602,605,9987,504,8076,4782,6403,3029,6695,11184,142,5681,8812,2844,3438,8077,975,58,12048,1003,8757,885,6281,1956,5009,12225,3656,11606,9830,1566,5782,2503,2948,7032,3834,5919,4433,3054,6803,9166,1747,10211,11177,4322,1958,922,11848,4079,11231,4046,11580,1319,9139,6224,835,8049,8719,7105,1200,6122,9734,3956,1360,6119,5297,4298,3329,168,2692,1594,10327,5106,6328,3728,8240,5990,11130,948,1146,10885,325,8212,4016,8527,2919,295,6190,652,5766,11713,8326,6142,2447,1805,2882,10238,1954,1843,9928,4115,3030,2908,12071,8760,3434,5876,2281,2031,5333,8298,8320,12133,2767,11836,5908,11871,8517,6860,7515,10996,4737,2500,10800,5942,1583,11026,12240,5915,10806,1815,5383,1512,11939,2057,6920,9087,7796,8974,426,4754,1858,8532,10314,11942,2925,174,11566,3009,1693,2655,6554,5868,2738,11796,8193,9908,5444,10911,1912,7952,435,404,7644,11224,10146,7012,11121,11082,9041,9723,2187,9867,6250,3646,9852,6267,2987,8509,875,4976,10682,8005,5088,7278,11287,9223,27,3763,10849,11272,7404,5084,10657,8146,4714,12047,10752,2678,3704,545,7270,1067,5101,442,2401,390,11516,3778,8456,1045,9430,9808,5012,9377,6591,11935,4861,7852,3,3149,12129,12176,4919,10123,3915,3636,7351,2704,5291,1663,1777,1426,7635,1484,7394,2780,7094,8236,2645,7247,2305,2847,7875,7917,10115,10600,8925,4057,3271,9273,243,9289,11618,3136,5191,8889,9890,11869,5559,10111,10745,11813,8758,4905,3985,9603,9042,3978,9320,3510,5332,9424,2370,9405,11136,2249,8241,10659,10163,9103,6882,10810,1,5146,4043,8155,5736,11567,1305,1212,10643,9094,5860,8747,8785,8668,2545,4591,6561,5023,6461,10938,4978,6512,8961,949,2625,2639,7468,11726,2975,9545,9283,3091,81,11289,7969,9238,9923,2963,7393,12149,1853,11563,7678,8034,11112,1635,9521,3201,3014,1326,7203,1170,9970,11334,790,3135,3712,4846,2747,3553,7484,11227,2294,11267,9,9447,11809,11950,2468,5791,11745,10908,9764,8112,3584,4989,5331,4278,10616,4452,9893,8340,8993,130,7935,9452,6915,8541,11336,11462,5767,7222,2197,12171,9813,3241,729,3289,10276,9408,3284,2089,5092,11029,4388,5755,7657,10861,1696,2426,11955,4231,2548,11934,3382,10530,3707,3694,7110,3637,8830,6747,145,7399,5911,2731,8357,};
uint16_t psis_inv_montgomery[NEWHOPE_N] = {512,3944,4267,5411,9615,5900,3205,6063,9261,2021,3087,4770,1029,1590,343,530,8307,4273,2769,9617,923,7302,4404,2434,1468,9004,8682,11194,2894,11924,5061,8071,1687,10883,8755,7724,11111,6671,7800,6320,2600,6203,4963,6164,9847,6151,11475,10243,3825,11607,1275,3869,425,5386,4238,9988,5509,11522,10029,7937,3343,6742,9307,10440,11295,3480,3765,1160,1255,4483,8611,9687,11063,3229,7784,9269,6691,7186,10423,10588,11667,11722,3889,12100,9489,12226,3163,12268,9247,12282,11275,4094,11951,5461,8080,10013,10886,7434,7725,2478,2575,826,9051,8468,3017,6919,5102,10499,5797,7596,10125,2532,3375,844,1125,8474,375,6921,125,2307,4138,769,9572,8449,7287,11009,2429,7766,4906,6685,9828,10421,3276,7570,1092,10716,364,3572,8314,5287,10964,9955,7751,11511,6680,3837,6323,1279,6204,8619,2068,2873,8882,5054,7057,5781,10545,1927,3515,8835,5268,2945,1756,5078,8778,5789,2926,6026,9168,6105,3056,2035,5115,8871,1705,2957,8761,5082,11113,1694,11897,4661,8062,5650,10880,10076,7723,7455,10767,2485,3589,9021,9389,3007,7226,9195,6505,3065,10361,5118,7550,1706,6613,4665,10397,1555,7562,8711,6617,7000,6302,10526,6197,7605,6162,2535,2054,845,4781,4378,5690,9652,5993,11410,6094,11996,10224,8095,3408,10891,1136,11823,4475,3941,5588,5410,5959,9996,10179,3332,3393,5207,1131,5832,377,1944,4222,648,9600,216,3200,72,5163,24,1721,8,4670,4099,5653,9559,10077,11379,3359,3793,5216,9457,5835,11345,1945,7878,8841,2626,2947,9068,9175,7119,11251,2373,11943,791,3981,4360,1327,9646,8635,11408,11071,7899,11883,2633,3961,4974,9513,1658,3171,4649,1057,5646,8545,1882,11041,8820,11873,2940,8054,980,6781,4423,10453,9667,11677,11415,12085,3805,12221,9461,8170,7250,10916,6513,7735,2171,10771,4820,11783,5703,8024,1901,6771,4730,2257,5673,8945,1891,7078,8823,10552,2941,11710,9173,12096,7154,4032,6481,1344,10353,448,3451,8342,9343,6877,11307,10485,3769,3495,9449,1165,7246,8581,10608,11053,3536,11877,5275,3959,9951,5416,3317,9998,5202,7429,1734,10669,578,11749,4289,12109,5526,12229,1842,12269,614,8186,4301,6825,5530,2275,10036,8951,11538,7080,3846,2360,1282,4883,8620,5724,11066,1908,7785,636,2595,212,865,4167,8481,1389,2827,463,9135,8347,3045,10975,1015,11851,8531,12143,6940,8144,10506,6811,3502,10463,9360,7584,3120,2528,1040,4939,4443,9839,1481,7376,4590,6555,1530,2185,510,8921,170,7070,4153,6453,9577,2151,11385,717,3795,239,1265,4176,4518,1392,1506,464,502,4251,8360,1417,6883,8665,10487,11081,7592,7790,6627,6693,2209,2231,8929,4840,11169,9806,3723,7365,1241,2455,4510,9011,9696,7100,3232,6463,9270,10347,3090,3449,1030,5246,8536,5845,11038,10141,11872,11573,12150,7954,4050,10844,1350,7711,450,10763,150,7684,50,10754,4113,7681,1371,10753,457,};
unsigned int bitrev_lut [NEWHOPE_N] = {0,256,128,384,64,320,192,448,32,288,160,416,96,352,224,480,16,272,144,400,80,336,208,464,48,304,176,432,112,368,240,496,8,264,136,392,72,328,200,456,40,296,168,424,104,360,232,488,24,280,152,408,88,344,216,472,56,312,184,440,120,376,248,504,4,260,132,388,68,324,196,452,36,292,164,420,100,356,228,484,20,276,148,404,84,340,212,468,52,308,180,436,116,372,244,500,12,268,140,396,76,332,204,460,44,300,172,428,108,364,236,492,28,284,156,412,92,348,220,476,60,316,188,444,124,380,252,508,2,258,130,386,66,322,194,450,34,290,162,418,98,354,226,482,18,274,146,402,82,338,210,466,50,306,178,434,114,370,242,498,10,266,138,394,74,330,202,458,42,298,170,426,106,362,234,490,26,282,154,410,90,346,218,474,58,314,186,442,122,378,250,506,6,262,134,390,70,326,198,454,38,294,166,422,102,358,230,486,22,278,150,406,86,342,214,470,54,310,182,438,118,374,246,502,14,270,142,398,78,334,206,462,46,302,174,430,110,366,238,494,30,286,158,414,94,350,222,478,62,318,190,446,126,382,254,510,1,257,129,385,65,321,193,449,33,289,161,417,97,353,225,481,17,273,145,401,81,337,209,465,49,305,177,433,113,369,241,497,9,265,137,393,73,329,201,457,41,297,169,425,105,361,233,489,25,281,153,409,89,345,217,473,57,313,185,441,121,377,249,505,5,261,133,389,69,325,197,453,37,293,165,421,101,357,229,485,21,277,149,405,85,341,213,469,53,309,181,437,117,373,245,501,13,269,141,397,77,333,205,461,45,301,173,429,109,365,237,493,29,285,157,413,93,349,221,477,61,317,189,445,125,381,253,509,3,259,131,387,67,323,195,451,35,291,163,419,99,355,227,483,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,};

#define TO_BYTES_BLOCK(i) do{\
  x = p->coeffs[4*i+0];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t0 = m ^ t;\
  x = p->coeffs[4*i+1];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t1 = m ^ t;\
  x = p->coeffs[4*i+2];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t2 = m ^ t;\
  x = p->coeffs[4*i+3];\
  u = ((uint32_t) x * 5) >> 16;\ 
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = x;\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t = r2^m;\
  t = t & c;\
  t3 = m ^ t;\
    r[7*i+0] =  t0 & 0xff;\
    r[7*i+1] = (t0 >> 8) | (t1 << 6);\
    r[7*i+2] = (t1 >> 2);\
    r[7*i+3] = (t1 >> 10) | (t2 << 4);\
    r[7*i+4] = (t2 >> 4);\
    r[7*i+5] = (t2 >> 12) | (t3 << 2);\
    r[7*i+6] = (t3 >> 6);\
} while(0)

void poly_tobytes(unsigned char *r, const poly *p)
{
  uint16_t t0,t1,t2,t3;
  uint16_t x, m, r2, t;
  int16_t c;
  uint32_t u;

  TO_BYTES_BLOCK(0);
  TO_BYTES_BLOCK(1);
  TO_BYTES_BLOCK(2);
  TO_BYTES_BLOCK(3);
  TO_BYTES_BLOCK(4);
  TO_BYTES_BLOCK(5);
  TO_BYTES_BLOCK(6);
  TO_BYTES_BLOCK(7);
  TO_BYTES_BLOCK(8);
  TO_BYTES_BLOCK(9);
  TO_BYTES_BLOCK(10);
  TO_BYTES_BLOCK(11);
  TO_BYTES_BLOCK(12);
  TO_BYTES_BLOCK(13);
  TO_BYTES_BLOCK(14);
  TO_BYTES_BLOCK(15);
  TO_BYTES_BLOCK(16);
  TO_BYTES_BLOCK(17);
  TO_BYTES_BLOCK(18);
  TO_BYTES_BLOCK(19);
  TO_BYTES_BLOCK(20);
  TO_BYTES_BLOCK(21);
  TO_BYTES_BLOCK(22);
  TO_BYTES_BLOCK(23);
  TO_BYTES_BLOCK(24);
  TO_BYTES_BLOCK(25);
  TO_BYTES_BLOCK(26);
  TO_BYTES_BLOCK(27);
  TO_BYTES_BLOCK(28);
  TO_BYTES_BLOCK(29);
  TO_BYTES_BLOCK(30);
  TO_BYTES_BLOCK(31);
  TO_BYTES_BLOCK(32);
  TO_BYTES_BLOCK(33);
  TO_BYTES_BLOCK(34);
  TO_BYTES_BLOCK(35);
  TO_BYTES_BLOCK(36);
  TO_BYTES_BLOCK(37);
  TO_BYTES_BLOCK(38);
  TO_BYTES_BLOCK(39);
  TO_BYTES_BLOCK(40);
  TO_BYTES_BLOCK(41);
  TO_BYTES_BLOCK(42);
  TO_BYTES_BLOCK(43);
  TO_BYTES_BLOCK(44);
  TO_BYTES_BLOCK(45);
  TO_BYTES_BLOCK(46);
  TO_BYTES_BLOCK(47);
  TO_BYTES_BLOCK(48);
  TO_BYTES_BLOCK(49);
  TO_BYTES_BLOCK(50);
  TO_BYTES_BLOCK(51);
  TO_BYTES_BLOCK(52);
  TO_BYTES_BLOCK(53);
  TO_BYTES_BLOCK(54);
  TO_BYTES_BLOCK(55);
  TO_BYTES_BLOCK(56);
  TO_BYTES_BLOCK(57);
  TO_BYTES_BLOCK(58);
  TO_BYTES_BLOCK(59);
  TO_BYTES_BLOCK(60);
  TO_BYTES_BLOCK(61);
  TO_BYTES_BLOCK(62);
  TO_BYTES_BLOCK(63);
  TO_BYTES_BLOCK(64);
  TO_BYTES_BLOCK(65);
  TO_BYTES_BLOCK(66);
  TO_BYTES_BLOCK(67);
  TO_BYTES_BLOCK(68);
  TO_BYTES_BLOCK(69);
  TO_BYTES_BLOCK(70);
  TO_BYTES_BLOCK(71);
  TO_BYTES_BLOCK(72);
  TO_BYTES_BLOCK(73);
  TO_BYTES_BLOCK(74);
  TO_BYTES_BLOCK(75);
  TO_BYTES_BLOCK(76);
  TO_BYTES_BLOCK(77);
  TO_BYTES_BLOCK(78);
  TO_BYTES_BLOCK(79);
  TO_BYTES_BLOCK(80);
  TO_BYTES_BLOCK(81);
  TO_BYTES_BLOCK(82);
  TO_BYTES_BLOCK(83);
  TO_BYTES_BLOCK(84);
  TO_BYTES_BLOCK(85);
  TO_BYTES_BLOCK(86);
  TO_BYTES_BLOCK(87);
  TO_BYTES_BLOCK(88);
  TO_BYTES_BLOCK(89);
  TO_BYTES_BLOCK(90);
  TO_BYTES_BLOCK(91);
  TO_BYTES_BLOCK(92);
  TO_BYTES_BLOCK(93);
  TO_BYTES_BLOCK(94);
  TO_BYTES_BLOCK(95);
  TO_BYTES_BLOCK(96);
  TO_BYTES_BLOCK(97);
  TO_BYTES_BLOCK(98);
  TO_BYTES_BLOCK(99);
  TO_BYTES_BLOCK(100);
  TO_BYTES_BLOCK(101);
  TO_BYTES_BLOCK(102);
  TO_BYTES_BLOCK(103);
  TO_BYTES_BLOCK(104);
  TO_BYTES_BLOCK(105);
  TO_BYTES_BLOCK(106);
  TO_BYTES_BLOCK(107);
  TO_BYTES_BLOCK(108);
  TO_BYTES_BLOCK(109);
  TO_BYTES_BLOCK(110);
  TO_BYTES_BLOCK(111);
  TO_BYTES_BLOCK(112);
  TO_BYTES_BLOCK(113);
  TO_BYTES_BLOCK(114);
  TO_BYTES_BLOCK(115);
  TO_BYTES_BLOCK(116);
  TO_BYTES_BLOCK(117);
  TO_BYTES_BLOCK(118);
  TO_BYTES_BLOCK(119);
  TO_BYTES_BLOCK(120);
  TO_BYTES_BLOCK(121);
  TO_BYTES_BLOCK(122);
  TO_BYTES_BLOCK(123);
  TO_BYTES_BLOCK(124);
  TO_BYTES_BLOCK(125);
  TO_BYTES_BLOCK(126);
  TO_BYTES_BLOCK(127);
}

#define COMPRESS_SUB_BLOCK(j,i) do{\
  x = p->coeffs[i+j];\
  u = ((uint32_t) x * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x -= u;\
  r2 = p->coeffs[i+j];\
  m = r2 - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r2^m;\
  t2 = t2 & c;\
  t[j] = m ^ t2; \
      t[j] = (((t[j] << 3) + NEWHOPE_Q/2)/NEWHOPE_Q) & 0x7;\
} while(0)

#define COMPRESS_BLOCK(i) do{\
   COMPRESS_SUB_BLOCK(0, i);\
   COMPRESS_SUB_BLOCK(1, i);\
   COMPRESS_SUB_BLOCK(2, i);\
   COMPRESS_SUB_BLOCK(3, i);\
   COMPRESS_SUB_BLOCK(4, i);\
   COMPRESS_SUB_BLOCK(5, i);\
   COMPRESS_SUB_BLOCK(6, i);\
   COMPRESS_SUB_BLOCK(7, i);\
    r[k]   =  t[0]       | (t[1] << 3) | (t[2] << 6);\
    r[k+1] = (t[2] >> 2) | (t[3] << 1) | (t[4] << 4) | (t[5] << 7);\
    r[k+2] = (t[5] >> 1) | (t[6] << 2) | (t[7] << 5);\
    k += 3;\
} while(0)

void poly_compress(unsigned char *r, const poly *p)
{
  unsigned int k=0;
  uint32_t t[8];
 uint16_t m,r2, t2, x;
  int16_t c;
  uint32_t u;
   
  COMPRESS_BLOCK(0);
  COMPRESS_BLOCK(8);
  COMPRESS_BLOCK(16);
  COMPRESS_BLOCK(24);
  COMPRESS_BLOCK(32);
  COMPRESS_BLOCK(40);
  COMPRESS_BLOCK(48);
  COMPRESS_BLOCK(56);
  COMPRESS_BLOCK(64);
  COMPRESS_BLOCK(72);
  COMPRESS_BLOCK(80);
  COMPRESS_BLOCK(88);
  COMPRESS_BLOCK(96);
  COMPRESS_BLOCK(104);
  COMPRESS_BLOCK(112);
  COMPRESS_BLOCK(120);
  COMPRESS_BLOCK(128);
  COMPRESS_BLOCK(136);
  COMPRESS_BLOCK(144);
  COMPRESS_BLOCK(152);
  COMPRESS_BLOCK(160);
  COMPRESS_BLOCK(168);
  COMPRESS_BLOCK(176);
  COMPRESS_BLOCK(184);
  COMPRESS_BLOCK(192);
  COMPRESS_BLOCK(200);
  COMPRESS_BLOCK(208);
  COMPRESS_BLOCK(216);
  COMPRESS_BLOCK(224);
  COMPRESS_BLOCK(232);
  COMPRESS_BLOCK(240);
  COMPRESS_BLOCK(248);
  COMPRESS_BLOCK(256);
  COMPRESS_BLOCK(264);
  COMPRESS_BLOCK(272);
  COMPRESS_BLOCK(280);
  COMPRESS_BLOCK(288);
  COMPRESS_BLOCK(296);
  COMPRESS_BLOCK(304);
  COMPRESS_BLOCK(312);
  COMPRESS_BLOCK(320);
  COMPRESS_BLOCK(328);
  COMPRESS_BLOCK(336);
  COMPRESS_BLOCK(344);
  COMPRESS_BLOCK(352);
  COMPRESS_BLOCK(360);
  COMPRESS_BLOCK(368);
  COMPRESS_BLOCK(376);
  COMPRESS_BLOCK(384);
  COMPRESS_BLOCK(392);
  COMPRESS_BLOCK(400);
  COMPRESS_BLOCK(408);
  COMPRESS_BLOCK(416);
  COMPRESS_BLOCK(424);
  COMPRESS_BLOCK(432);
  COMPRESS_BLOCK(440);
  COMPRESS_BLOCK(448);
  COMPRESS_BLOCK(456);
  COMPRESS_BLOCK(464);
  COMPRESS_BLOCK(472);
  COMPRESS_BLOCK(480);
  COMPRESS_BLOCK(488);
  COMPRESS_BLOCK(496);
  COMPRESS_BLOCK(504);
}

#define DECOMPRESS_SUB_BLOCK(j, i) do{\
      r->coeffs[i+j] = ((uint32_t)r->coeffs[i+j] * NEWHOPE_Q + 4) >> 3;\
} while(0)

#define DECOMPRESS_BLOCK(i) do{\
    r->coeffs[i+0] =  a[0] & 7;\
    r->coeffs[i+1] = (a[0] >> 3) & 7;\
    r->coeffs[i+2] = (a[0] >> 6) | ((a[1] << 2) & 4);\
    r->coeffs[i+3] = (a[1] >> 1) & 7;\
    r->coeffs[i+4] = (a[1] >> 4) & 7;\
    r->coeffs[i+5] = (a[1] >> 7) | ((a[2] << 1) & 6);\
    r->coeffs[i+6] = (a[2] >> 2) & 7;\
    r->coeffs[i+7] = (a[2] >> 5);\
    a += 3;\
    DECOMPRESS_SUB_BLOCK(0, i);\
    DECOMPRESS_SUB_BLOCK(1, i);\
    DECOMPRESS_SUB_BLOCK(2, i);\
    DECOMPRESS_SUB_BLOCK(3, i);\
    DECOMPRESS_SUB_BLOCK(4, i);\
    DECOMPRESS_SUB_BLOCK(5, i);\
    DECOMPRESS_SUB_BLOCK(6, i);\
    DECOMPRESS_SUB_BLOCK(7, i);\
} while(0)


void poly_decompress(poly *r, const unsigned char *a)
{
  DECOMPRESS_BLOCK(0);
  DECOMPRESS_BLOCK(8);
  DECOMPRESS_BLOCK(16);
  DECOMPRESS_BLOCK(24);
  DECOMPRESS_BLOCK(32);
  DECOMPRESS_BLOCK(40);
  DECOMPRESS_BLOCK(48);
  DECOMPRESS_BLOCK(56);
  DECOMPRESS_BLOCK(64);
  DECOMPRESS_BLOCK(72);
  DECOMPRESS_BLOCK(80);
  DECOMPRESS_BLOCK(88);
  DECOMPRESS_BLOCK(96);
  DECOMPRESS_BLOCK(104);
  DECOMPRESS_BLOCK(112);
  DECOMPRESS_BLOCK(120);
  DECOMPRESS_BLOCK(128);
  DECOMPRESS_BLOCK(136);
  DECOMPRESS_BLOCK(144);
  DECOMPRESS_BLOCK(152);
  DECOMPRESS_BLOCK(160);
  DECOMPRESS_BLOCK(168);
  DECOMPRESS_BLOCK(176);
  DECOMPRESS_BLOCK(184);
  DECOMPRESS_BLOCK(192);
  DECOMPRESS_BLOCK(200);
  DECOMPRESS_BLOCK(208);
  DECOMPRESS_BLOCK(216);
  DECOMPRESS_BLOCK(224);
  DECOMPRESS_BLOCK(232);
  DECOMPRESS_BLOCK(240);
  DECOMPRESS_BLOCK(248);
  DECOMPRESS_BLOCK(256);
  DECOMPRESS_BLOCK(264);
  DECOMPRESS_BLOCK(272);
  DECOMPRESS_BLOCK(280);
  DECOMPRESS_BLOCK(288);
  DECOMPRESS_BLOCK(296);
  DECOMPRESS_BLOCK(304);
  DECOMPRESS_BLOCK(312);
  DECOMPRESS_BLOCK(320);
  DECOMPRESS_BLOCK(328);
  DECOMPRESS_BLOCK(336);
  DECOMPRESS_BLOCK(344);
  DECOMPRESS_BLOCK(352);
  DECOMPRESS_BLOCK(360);
  DECOMPRESS_BLOCK(368);
  DECOMPRESS_BLOCK(376);
  DECOMPRESS_BLOCK(384);
  DECOMPRESS_BLOCK(392);
  DECOMPRESS_BLOCK(400);
  DECOMPRESS_BLOCK(408);
  DECOMPRESS_BLOCK(416);
  DECOMPRESS_BLOCK(424);
  DECOMPRESS_BLOCK(432);
  DECOMPRESS_BLOCK(440);
  DECOMPRESS_BLOCK(448);
  DECOMPRESS_BLOCK(456);
  DECOMPRESS_BLOCK(464);
  DECOMPRESS_BLOCK(472);
  DECOMPRESS_BLOCK(480);
  DECOMPRESS_BLOCK(488);
  DECOMPRESS_BLOCK(496);
  DECOMPRESS_BLOCK(504);
}

#define FROM_SUB_BLOCK(j, i) do {\
      mask = -((msg[i] >> j)&1);\
      r->coeffs[8*i+j+  0] = mask & (NEWHOPE_Q/2);\
      r->coeffs[8*i+j+256] = mask & (NEWHOPE_Q/2);\
} while(0)

void poly_frommsg(poly *r, const unsigned char *msg)
{
  unsigned int i,j,mask;
  
  FROM_SUB_BLOCK(0, 0);
  FROM_SUB_BLOCK(1, 0);
  FROM_SUB_BLOCK(2, 0);
  FROM_SUB_BLOCK(3, 0);
  FROM_SUB_BLOCK(4, 0);
  FROM_SUB_BLOCK(5, 0);
  FROM_SUB_BLOCK(6, 0);
  FROM_SUB_BLOCK(7, 0);
  FROM_SUB_BLOCK(0, 1);
  FROM_SUB_BLOCK(1, 1);
  FROM_SUB_BLOCK(2, 1);
  FROM_SUB_BLOCK(3, 1);
  FROM_SUB_BLOCK(4, 1);
  FROM_SUB_BLOCK(5, 1);
  FROM_SUB_BLOCK(6, 1);
  FROM_SUB_BLOCK(7, 1);
  FROM_SUB_BLOCK(0, 2);
  FROM_SUB_BLOCK(1, 2);
  FROM_SUB_BLOCK(2, 2);
  FROM_SUB_BLOCK(3, 2);
  FROM_SUB_BLOCK(4, 2);
  FROM_SUB_BLOCK(5, 2);
  FROM_SUB_BLOCK(6, 2);
  FROM_SUB_BLOCK(7, 2);
  FROM_SUB_BLOCK(0, 3);
  FROM_SUB_BLOCK(1, 3);
  FROM_SUB_BLOCK(2, 3);
  FROM_SUB_BLOCK(3, 3);
  FROM_SUB_BLOCK(4, 3);
  FROM_SUB_BLOCK(5, 3);
  FROM_SUB_BLOCK(6, 3);
  FROM_SUB_BLOCK(7, 3);
  FROM_SUB_BLOCK(0, 4);
  FROM_SUB_BLOCK(1, 4);
  FROM_SUB_BLOCK(2, 4);
  FROM_SUB_BLOCK(3, 4);
  FROM_SUB_BLOCK(4, 4);
  FROM_SUB_BLOCK(5, 4);
  FROM_SUB_BLOCK(6, 4);
  FROM_SUB_BLOCK(7, 4);
  FROM_SUB_BLOCK(0, 5);
  FROM_SUB_BLOCK(1, 5);
  FROM_SUB_BLOCK(2, 5);
  FROM_SUB_BLOCK(3, 5);
  FROM_SUB_BLOCK(4, 5);
  FROM_SUB_BLOCK(5, 5);
  FROM_SUB_BLOCK(6, 5);
  FROM_SUB_BLOCK(7, 5);
  FROM_SUB_BLOCK(0, 6);
  FROM_SUB_BLOCK(1, 6);
  FROM_SUB_BLOCK(2, 6);
  FROM_SUB_BLOCK(3, 6);
  FROM_SUB_BLOCK(4, 6);
  FROM_SUB_BLOCK(5, 6);
  FROM_SUB_BLOCK(6, 6);
  FROM_SUB_BLOCK(7, 6);
  FROM_SUB_BLOCK(0, 7);
  FROM_SUB_BLOCK(1, 7);
  FROM_SUB_BLOCK(2, 7);
  FROM_SUB_BLOCK(3, 7);
  FROM_SUB_BLOCK(4, 7);
  FROM_SUB_BLOCK(5, 7);
  FROM_SUB_BLOCK(6, 7);
  FROM_SUB_BLOCK(7, 7);
  FROM_SUB_BLOCK(0, 8);
  FROM_SUB_BLOCK(1, 8);
  FROM_SUB_BLOCK(2, 8);
  FROM_SUB_BLOCK(3, 8);
  FROM_SUB_BLOCK(4, 8);
  FROM_SUB_BLOCK(5, 8);
  FROM_SUB_BLOCK(6, 8);
  FROM_SUB_BLOCK(7, 8);
  FROM_SUB_BLOCK(0, 9);
  FROM_SUB_BLOCK(1, 9);
  FROM_SUB_BLOCK(2, 9);
  FROM_SUB_BLOCK(3, 9);
  FROM_SUB_BLOCK(4, 9);
  FROM_SUB_BLOCK(5, 9);
  FROM_SUB_BLOCK(6, 9);
  FROM_SUB_BLOCK(7, 9);
  FROM_SUB_BLOCK(0, 10);
  FROM_SUB_BLOCK(1, 10);
  FROM_SUB_BLOCK(2, 10);
  FROM_SUB_BLOCK(3, 10);
  FROM_SUB_BLOCK(4, 10);
  FROM_SUB_BLOCK(5, 10);
  FROM_SUB_BLOCK(6, 10);
  FROM_SUB_BLOCK(7, 10);
  FROM_SUB_BLOCK(0, 11);
  FROM_SUB_BLOCK(1, 11);
  FROM_SUB_BLOCK(2, 11);
  FROM_SUB_BLOCK(3, 11);
  FROM_SUB_BLOCK(4, 11);
  FROM_SUB_BLOCK(5, 11);
  FROM_SUB_BLOCK(6, 11);
  FROM_SUB_BLOCK(7, 11);
  FROM_SUB_BLOCK(0, 12);
  FROM_SUB_BLOCK(1, 12);
  FROM_SUB_BLOCK(2, 12);
  FROM_SUB_BLOCK(3, 12);
  FROM_SUB_BLOCK(4, 12);
  FROM_SUB_BLOCK(5, 12);
  FROM_SUB_BLOCK(6, 12);
  FROM_SUB_BLOCK(7, 12);
  FROM_SUB_BLOCK(0, 13);
  FROM_SUB_BLOCK(1, 13);
  FROM_SUB_BLOCK(2, 13);
  FROM_SUB_BLOCK(3, 13);
  FROM_SUB_BLOCK(4, 13);
  FROM_SUB_BLOCK(5, 13);
  FROM_SUB_BLOCK(6, 13);
  FROM_SUB_BLOCK(7, 13);
  FROM_SUB_BLOCK(0, 14);
  FROM_SUB_BLOCK(1, 14);
  FROM_SUB_BLOCK(2, 14);
  FROM_SUB_BLOCK(3, 14);
  FROM_SUB_BLOCK(4, 14);
  FROM_SUB_BLOCK(5, 14);
  FROM_SUB_BLOCK(6, 14);
  FROM_SUB_BLOCK(7, 14);
  FROM_SUB_BLOCK(0, 15);
  FROM_SUB_BLOCK(1, 15);
  FROM_SUB_BLOCK(2, 15);
  FROM_SUB_BLOCK(3, 15);
  FROM_SUB_BLOCK(4, 15);
  FROM_SUB_BLOCK(5, 15);
  FROM_SUB_BLOCK(6, 15);
  FROM_SUB_BLOCK(7, 15);
  FROM_SUB_BLOCK(0, 16);
  FROM_SUB_BLOCK(1, 16);
  FROM_SUB_BLOCK(2, 16);
  FROM_SUB_BLOCK(3, 16);
  FROM_SUB_BLOCK(4, 16);
  FROM_SUB_BLOCK(5, 16);
  FROM_SUB_BLOCK(6, 16);
  FROM_SUB_BLOCK(7, 16);
  FROM_SUB_BLOCK(0, 17);
  FROM_SUB_BLOCK(1, 17);
  FROM_SUB_BLOCK(2, 17);
  FROM_SUB_BLOCK(3, 17);
  FROM_SUB_BLOCK(4, 17);
  FROM_SUB_BLOCK(5, 17);
  FROM_SUB_BLOCK(6, 17);
  FROM_SUB_BLOCK(7, 17);
  FROM_SUB_BLOCK(0, 18);
  FROM_SUB_BLOCK(1, 18);
  FROM_SUB_BLOCK(2, 18);
  FROM_SUB_BLOCK(3, 18);
  FROM_SUB_BLOCK(4, 18);
  FROM_SUB_BLOCK(5, 18);
  FROM_SUB_BLOCK(6, 18);
  FROM_SUB_BLOCK(7, 18);
  FROM_SUB_BLOCK(0, 19);
  FROM_SUB_BLOCK(1, 19);
  FROM_SUB_BLOCK(2, 19);
  FROM_SUB_BLOCK(3, 19);
  FROM_SUB_BLOCK(4, 19);
  FROM_SUB_BLOCK(5, 19);
  FROM_SUB_BLOCK(6, 19);
  FROM_SUB_BLOCK(7, 19);
  FROM_SUB_BLOCK(0, 20);
  FROM_SUB_BLOCK(1, 20);
  FROM_SUB_BLOCK(2, 20);
  FROM_SUB_BLOCK(3, 20);
  FROM_SUB_BLOCK(4, 20);
  FROM_SUB_BLOCK(5, 20);
  FROM_SUB_BLOCK(6, 20);
  FROM_SUB_BLOCK(7, 20);
  FROM_SUB_BLOCK(0, 21);
  FROM_SUB_BLOCK(1, 21);
  FROM_SUB_BLOCK(2, 21);
  FROM_SUB_BLOCK(3, 21);
  FROM_SUB_BLOCK(4, 21);
  FROM_SUB_BLOCK(5, 21);
  FROM_SUB_BLOCK(6, 21);
  FROM_SUB_BLOCK(7, 21);
  FROM_SUB_BLOCK(0, 22);
  FROM_SUB_BLOCK(1, 22);
  FROM_SUB_BLOCK(2, 22);
  FROM_SUB_BLOCK(3, 22);
  FROM_SUB_BLOCK(4, 22);
  FROM_SUB_BLOCK(5, 22);
  FROM_SUB_BLOCK(6, 22);
  FROM_SUB_BLOCK(7, 22);
  FROM_SUB_BLOCK(0, 23);
  FROM_SUB_BLOCK(1, 23);
  FROM_SUB_BLOCK(2, 23);
  FROM_SUB_BLOCK(3, 23);
  FROM_SUB_BLOCK(4, 23);
  FROM_SUB_BLOCK(5, 23);
  FROM_SUB_BLOCK(6, 23);
  FROM_SUB_BLOCK(7, 23);
  FROM_SUB_BLOCK(0, 24);
  FROM_SUB_BLOCK(1, 24);
  FROM_SUB_BLOCK(2, 24);
  FROM_SUB_BLOCK(3, 24);
  FROM_SUB_BLOCK(4, 24);
  FROM_SUB_BLOCK(5, 24);
  FROM_SUB_BLOCK(6, 24);
  FROM_SUB_BLOCK(7, 24);
  FROM_SUB_BLOCK(0, 25);
  FROM_SUB_BLOCK(1, 25);
  FROM_SUB_BLOCK(2, 25);
  FROM_SUB_BLOCK(3, 25);
  FROM_SUB_BLOCK(4, 25);
  FROM_SUB_BLOCK(5, 25);
  FROM_SUB_BLOCK(6, 25);
  FROM_SUB_BLOCK(7, 25);
  FROM_SUB_BLOCK(0, 26);
  FROM_SUB_BLOCK(1, 26);
  FROM_SUB_BLOCK(2, 26);
  FROM_SUB_BLOCK(3, 26);
  FROM_SUB_BLOCK(4, 26);
  FROM_SUB_BLOCK(5, 26);
  FROM_SUB_BLOCK(6, 26);
  FROM_SUB_BLOCK(7, 26);
  FROM_SUB_BLOCK(0, 27);
  FROM_SUB_BLOCK(1, 27);
  FROM_SUB_BLOCK(2, 27);
  FROM_SUB_BLOCK(3, 27);
  FROM_SUB_BLOCK(4, 27);
  FROM_SUB_BLOCK(5, 27);
  FROM_SUB_BLOCK(6, 27);
  FROM_SUB_BLOCK(7, 27);
  FROM_SUB_BLOCK(0, 28);
  FROM_SUB_BLOCK(1, 28);
  FROM_SUB_BLOCK(2, 28);
  FROM_SUB_BLOCK(3, 28);
  FROM_SUB_BLOCK(4, 28);
  FROM_SUB_BLOCK(5, 28);
  FROM_SUB_BLOCK(6, 28);
  FROM_SUB_BLOCK(7, 28);
  FROM_SUB_BLOCK(0, 29);
  FROM_SUB_BLOCK(1, 29);
  FROM_SUB_BLOCK(2, 29);
  FROM_SUB_BLOCK(3, 29);
  FROM_SUB_BLOCK(4, 29);
  FROM_SUB_BLOCK(5, 29);
  FROM_SUB_BLOCK(6, 29);
  FROM_SUB_BLOCK(7, 29);
  FROM_SUB_BLOCK(0, 30);
  FROM_SUB_BLOCK(1, 30);
  FROM_SUB_BLOCK(2, 30);
  FROM_SUB_BLOCK(3, 30);
  FROM_SUB_BLOCK(4, 30);
  FROM_SUB_BLOCK(5, 30);
  FROM_SUB_BLOCK(6, 30);
  FROM_SUB_BLOCK(7, 30);
  FROM_SUB_BLOCK(0, 31);
  FROM_SUB_BLOCK(1, 31);
  FROM_SUB_BLOCK(2, 31);
  FROM_SUB_BLOCK(3, 31);
  FROM_SUB_BLOCK(4, 31);
  FROM_SUB_BLOCK(5, 31);
  FROM_SUB_BLOCK(6, 31);
  FROM_SUB_BLOCK(7, 31);
}

#define TO_MSG_BLOCK(i) do {\
  x2 = x->coeffs[i+  0];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t = t2 ^ m;\
  x2 = x->coeffs[i+256];\
  u = ((uint32_t) x2 * 5) >> 16;\
  u *= NEWHOPE_Q;\
  x2 -= u;\
  r = x2;\
  m = r - NEWHOPE_Q;\
  c = m;\
  c >>= 15;\
  t2 = r^m;\
  t2 = t2 & c;\
  r = m ^ t2;\
  r = r - NEWHOPE_Q/2;\
  m = r >> 15;\
  t2 = r + m;\
  t += t2 ^ m;\
    t = ((t - NEWHOPE_Q/2));\
    t >>= 15;\
    msg[i>>3] |= t<<(i&7);\
} while(0)

void poly_tomsg(unsigned char *msg, const poly *x)
{
  unsigned int i;
  uint16_t t, x2;
  int16_t r,m, t2;
  int16_t c;
  uint32_t u;

  msg[0] = 0;
  msg[1] = 0;
  msg[2] = 0;
  msg[3] = 0;
  msg[4] = 0;
  msg[5] = 0;
  msg[6] = 0;
  msg[7] = 0;
  msg[8] = 0;
  msg[9] = 0;
  msg[10] = 0;
  msg[11] = 0;
  msg[12] = 0;
  msg[13] = 0;
  msg[14] = 0;
  msg[15] = 0;
  msg[16] = 0;
  msg[17] = 0;
  msg[18] = 0;
  msg[19] = 0;
  msg[20] = 0;
  msg[21] = 0;
  msg[22] = 0;
  msg[23] = 0;
  msg[24] = 0;
  msg[25] = 0;
  msg[26] = 0;
  msg[27] = 0;
  msg[28] = 0;
  msg[29] = 0;
  msg[30] = 0;
  msg[31] = 0;
  
  TO_MSG_BLOCK(0);
  TO_MSG_BLOCK(1);
  TO_MSG_BLOCK(2);
  TO_MSG_BLOCK(3);
  TO_MSG_BLOCK(4);
  TO_MSG_BLOCK(5);
  TO_MSG_BLOCK(6);
  TO_MSG_BLOCK(7);
  TO_MSG_BLOCK(8);
  TO_MSG_BLOCK(9);
  TO_MSG_BLOCK(10);
  TO_MSG_BLOCK(11);
  TO_MSG_BLOCK(12);
  TO_MSG_BLOCK(13);
  TO_MSG_BLOCK(14);
  TO_MSG_BLOCK(15);
  TO_MSG_BLOCK(16);
  TO_MSG_BLOCK(17);
  TO_MSG_BLOCK(18);
  TO_MSG_BLOCK(19);
  TO_MSG_BLOCK(20);
  TO_MSG_BLOCK(21);
  TO_MSG_BLOCK(22);
  TO_MSG_BLOCK(23);
  TO_MSG_BLOCK(24);
  TO_MSG_BLOCK(25);
  TO_MSG_BLOCK(26);
  TO_MSG_BLOCK(27);
  TO_MSG_BLOCK(28);
  TO_MSG_BLOCK(29);
  TO_MSG_BLOCK(30);
  TO_MSG_BLOCK(31);
  TO_MSG_BLOCK(32);
  TO_MSG_BLOCK(33);
  TO_MSG_BLOCK(34);
  TO_MSG_BLOCK(35);
  TO_MSG_BLOCK(36);
  TO_MSG_BLOCK(37);
  TO_MSG_BLOCK(38);
  TO_MSG_BLOCK(39);
  TO_MSG_BLOCK(40);
  TO_MSG_BLOCK(41);
  TO_MSG_BLOCK(42);
  TO_MSG_BLOCK(43);
  TO_MSG_BLOCK(44);
  TO_MSG_BLOCK(45);
  TO_MSG_BLOCK(46);
  TO_MSG_BLOCK(47);
  TO_MSG_BLOCK(48);
  TO_MSG_BLOCK(49);
  TO_MSG_BLOCK(50);
  TO_MSG_BLOCK(51);
  TO_MSG_BLOCK(52);
  TO_MSG_BLOCK(53);
  TO_MSG_BLOCK(54);
  TO_MSG_BLOCK(55);
  TO_MSG_BLOCK(56);
  TO_MSG_BLOCK(57);
  TO_MSG_BLOCK(58);
  TO_MSG_BLOCK(59);
  TO_MSG_BLOCK(60);
  TO_MSG_BLOCK(61);
  TO_MSG_BLOCK(62);
  TO_MSG_BLOCK(63);
  TO_MSG_BLOCK(64);
  TO_MSG_BLOCK(65);
  TO_MSG_BLOCK(66);
  TO_MSG_BLOCK(67);
  TO_MSG_BLOCK(68);
  TO_MSG_BLOCK(69);
  TO_MSG_BLOCK(70);
  TO_MSG_BLOCK(71);
  TO_MSG_BLOCK(72);
  TO_MSG_BLOCK(73);
  TO_MSG_BLOCK(74);
  TO_MSG_BLOCK(75);
  TO_MSG_BLOCK(76);
  TO_MSG_BLOCK(77);
  TO_MSG_BLOCK(78);
  TO_MSG_BLOCK(79);
  TO_MSG_BLOCK(80);
  TO_MSG_BLOCK(81);
  TO_MSG_BLOCK(82);
  TO_MSG_BLOCK(83);
  TO_MSG_BLOCK(84);
  TO_MSG_BLOCK(85);
  TO_MSG_BLOCK(86);
  TO_MSG_BLOCK(87);
  TO_MSG_BLOCK(88);
  TO_MSG_BLOCK(89);
  TO_MSG_BLOCK(90);
  TO_MSG_BLOCK(91);
  TO_MSG_BLOCK(92);
  TO_MSG_BLOCK(93);
  TO_MSG_BLOCK(94);
  TO_MSG_BLOCK(95);
  TO_MSG_BLOCK(96);
  TO_MSG_BLOCK(97);
  TO_MSG_BLOCK(98);
  TO_MSG_BLOCK(99);
  TO_MSG_BLOCK(100);
  TO_MSG_BLOCK(101);
  TO_MSG_BLOCK(102);
  TO_MSG_BLOCK(103);
  TO_MSG_BLOCK(104);
  TO_MSG_BLOCK(105);
  TO_MSG_BLOCK(106);
  TO_MSG_BLOCK(107);
  TO_MSG_BLOCK(108);
  TO_MSG_BLOCK(109);
  TO_MSG_BLOCK(110);
  TO_MSG_BLOCK(111);
  TO_MSG_BLOCK(112);
  TO_MSG_BLOCK(113);
  TO_MSG_BLOCK(114);
  TO_MSG_BLOCK(115);
  TO_MSG_BLOCK(116);
  TO_MSG_BLOCK(117);
  TO_MSG_BLOCK(118);
  TO_MSG_BLOCK(119);
  TO_MSG_BLOCK(120);
  TO_MSG_BLOCK(121);
  TO_MSG_BLOCK(122);
  TO_MSG_BLOCK(123);
  TO_MSG_BLOCK(124);
  TO_MSG_BLOCK(125);
  TO_MSG_BLOCK(126);
  TO_MSG_BLOCK(127);
  TO_MSG_BLOCK(128);
  TO_MSG_BLOCK(129);
  TO_MSG_BLOCK(130);
  TO_MSG_BLOCK(131);
  TO_MSG_BLOCK(132);
  TO_MSG_BLOCK(133);
  TO_MSG_BLOCK(134);
  TO_MSG_BLOCK(135);
  TO_MSG_BLOCK(136);
  TO_MSG_BLOCK(137);
  TO_MSG_BLOCK(138);
  TO_MSG_BLOCK(139);
  TO_MSG_BLOCK(140);
  TO_MSG_BLOCK(141);
  TO_MSG_BLOCK(142);
  TO_MSG_BLOCK(143);
  TO_MSG_BLOCK(144);
  TO_MSG_BLOCK(145);
  TO_MSG_BLOCK(146);
  TO_MSG_BLOCK(147);
  TO_MSG_BLOCK(148);
  TO_MSG_BLOCK(149);
  TO_MSG_BLOCK(150);
  TO_MSG_BLOCK(151);
  TO_MSG_BLOCK(152);
  TO_MSG_BLOCK(153);
  TO_MSG_BLOCK(154);
  TO_MSG_BLOCK(155);
  TO_MSG_BLOCK(156);
  TO_MSG_BLOCK(157);
  TO_MSG_BLOCK(158);
  TO_MSG_BLOCK(159);
  TO_MSG_BLOCK(160);
  TO_MSG_BLOCK(161);
  TO_MSG_BLOCK(162);
  TO_MSG_BLOCK(163);
  TO_MSG_BLOCK(164);
  TO_MSG_BLOCK(165);
  TO_MSG_BLOCK(166);
  TO_MSG_BLOCK(167);
  TO_MSG_BLOCK(168);
  TO_MSG_BLOCK(169);
  TO_MSG_BLOCK(170);
  TO_MSG_BLOCK(171);
  TO_MSG_BLOCK(172);
  TO_MSG_BLOCK(173);
  TO_MSG_BLOCK(174);
  TO_MSG_BLOCK(175);
  TO_MSG_BLOCK(176);
  TO_MSG_BLOCK(177);
  TO_MSG_BLOCK(178);
  TO_MSG_BLOCK(179);
  TO_MSG_BLOCK(180);
  TO_MSG_BLOCK(181);
  TO_MSG_BLOCK(182);
  TO_MSG_BLOCK(183);
  TO_MSG_BLOCK(184);
  TO_MSG_BLOCK(185);
  TO_MSG_BLOCK(186);
  TO_MSG_BLOCK(187);
  TO_MSG_BLOCK(188);
  TO_MSG_BLOCK(189);
  TO_MSG_BLOCK(190);
  TO_MSG_BLOCK(191);
  TO_MSG_BLOCK(192);
  TO_MSG_BLOCK(193);
  TO_MSG_BLOCK(194);
  TO_MSG_BLOCK(195);
  TO_MSG_BLOCK(196);
  TO_MSG_BLOCK(197);
  TO_MSG_BLOCK(198);
  TO_MSG_BLOCK(199);
  TO_MSG_BLOCK(200);
  TO_MSG_BLOCK(201);
  TO_MSG_BLOCK(202);
  TO_MSG_BLOCK(203);
  TO_MSG_BLOCK(204);
  TO_MSG_BLOCK(205);
  TO_MSG_BLOCK(206);
  TO_MSG_BLOCK(207);
  TO_MSG_BLOCK(208);
  TO_MSG_BLOCK(209);
  TO_MSG_BLOCK(210);
  TO_MSG_BLOCK(211);
  TO_MSG_BLOCK(212);
  TO_MSG_BLOCK(213);
  TO_MSG_BLOCK(214);
  TO_MSG_BLOCK(215);
  TO_MSG_BLOCK(216);
  TO_MSG_BLOCK(217);
  TO_MSG_BLOCK(218);
  TO_MSG_BLOCK(219);
  TO_MSG_BLOCK(220);
  TO_MSG_BLOCK(221);
  TO_MSG_BLOCK(222);
  TO_MSG_BLOCK(223);
  TO_MSG_BLOCK(224);
  TO_MSG_BLOCK(225);
  TO_MSG_BLOCK(226);
  TO_MSG_BLOCK(227);
  TO_MSG_BLOCK(228);
  TO_MSG_BLOCK(229);
  TO_MSG_BLOCK(230);
  TO_MSG_BLOCK(231);
  TO_MSG_BLOCK(232);
  TO_MSG_BLOCK(233);
  TO_MSG_BLOCK(234);
  TO_MSG_BLOCK(235);
  TO_MSG_BLOCK(236);
  TO_MSG_BLOCK(237);
  TO_MSG_BLOCK(238);
  TO_MSG_BLOCK(239);
  TO_MSG_BLOCK(240);
  TO_MSG_BLOCK(241);
  TO_MSG_BLOCK(242);
  TO_MSG_BLOCK(243);
  TO_MSG_BLOCK(244);
  TO_MSG_BLOCK(245);
  TO_MSG_BLOCK(246);
  TO_MSG_BLOCK(247);
  TO_MSG_BLOCK(248);
  TO_MSG_BLOCK(249);
  TO_MSG_BLOCK(250);
  TO_MSG_BLOCK(251);
  TO_MSG_BLOCK(252);
  TO_MSG_BLOCK(253);
  TO_MSG_BLOCK(254);
  TO_MSG_BLOCK(255);
}

#define SUB_BLOCK(i) do {\
    r->coeffs[i] = barrett_reduce(a->coeffs[i] + 3*NEWHOPE_Q - b->coeffs[i]);\
} while(0)

void poly_sub(poly *r, const poly *a, const poly *b)
{
  SUB_BLOCK(0);
  SUB_BLOCK(1);
  SUB_BLOCK(2);
  SUB_BLOCK(3);
  SUB_BLOCK(4);
  SUB_BLOCK(5);
  SUB_BLOCK(6);
  SUB_BLOCK(7);
  SUB_BLOCK(8);
  SUB_BLOCK(9);
  SUB_BLOCK(10);
  SUB_BLOCK(11);
  SUB_BLOCK(12);
  SUB_BLOCK(13);
  SUB_BLOCK(14);
  SUB_BLOCK(15);
  SUB_BLOCK(16);
  SUB_BLOCK(17);
  SUB_BLOCK(18);
  SUB_BLOCK(19);
  SUB_BLOCK(20);
  SUB_BLOCK(21);
  SUB_BLOCK(22);
  SUB_BLOCK(23);
  SUB_BLOCK(24);
  SUB_BLOCK(25);
  SUB_BLOCK(26);
  SUB_BLOCK(27);
  SUB_BLOCK(28);
  SUB_BLOCK(29);
  SUB_BLOCK(30);
  SUB_BLOCK(31);
  SUB_BLOCK(32);
  SUB_BLOCK(33);
  SUB_BLOCK(34);
  SUB_BLOCK(35);
  SUB_BLOCK(36);
  SUB_BLOCK(37);
  SUB_BLOCK(38);
  SUB_BLOCK(39);
  SUB_BLOCK(40);
  SUB_BLOCK(41);
  SUB_BLOCK(42);
  SUB_BLOCK(43);
  SUB_BLOCK(44);
  SUB_BLOCK(45);
  SUB_BLOCK(46);
  SUB_BLOCK(47);
  SUB_BLOCK(48);
  SUB_BLOCK(49);
  SUB_BLOCK(50);
  SUB_BLOCK(51);
  SUB_BLOCK(52);
  SUB_BLOCK(53);
  SUB_BLOCK(54);
  SUB_BLOCK(55);
  SUB_BLOCK(56);
  SUB_BLOCK(57);
  SUB_BLOCK(58);
  SUB_BLOCK(59);
  SUB_BLOCK(60);
  SUB_BLOCK(61);
  SUB_BLOCK(62);
  SUB_BLOCK(63);
  SUB_BLOCK(64);
  SUB_BLOCK(65);
  SUB_BLOCK(66);
  SUB_BLOCK(67);
  SUB_BLOCK(68);
  SUB_BLOCK(69);
  SUB_BLOCK(70);
  SUB_BLOCK(71);
  SUB_BLOCK(72);
  SUB_BLOCK(73);
  SUB_BLOCK(74);
  SUB_BLOCK(75);
  SUB_BLOCK(76);
  SUB_BLOCK(77);
  SUB_BLOCK(78);
  SUB_BLOCK(79);
  SUB_BLOCK(80);
  SUB_BLOCK(81);
  SUB_BLOCK(82);
  SUB_BLOCK(83);
  SUB_BLOCK(84);
  SUB_BLOCK(85);
  SUB_BLOCK(86);
  SUB_BLOCK(87);
  SUB_BLOCK(88);
  SUB_BLOCK(89);
  SUB_BLOCK(90);
  SUB_BLOCK(91);
  SUB_BLOCK(92);
  SUB_BLOCK(93);
  SUB_BLOCK(94);
  SUB_BLOCK(95);
  SUB_BLOCK(96);
  SUB_BLOCK(97);
  SUB_BLOCK(98);
  SUB_BLOCK(99);
  SUB_BLOCK(100);
  SUB_BLOCK(101);
  SUB_BLOCK(102);
  SUB_BLOCK(103);
  SUB_BLOCK(104);
  SUB_BLOCK(105);
  SUB_BLOCK(106);
  SUB_BLOCK(107);
  SUB_BLOCK(108);
  SUB_BLOCK(109);
  SUB_BLOCK(110);
  SUB_BLOCK(111);
  SUB_BLOCK(112);
  SUB_BLOCK(113);
  SUB_BLOCK(114);
  SUB_BLOCK(115);
  SUB_BLOCK(116);
  SUB_BLOCK(117);
  SUB_BLOCK(118);
  SUB_BLOCK(119);
  SUB_BLOCK(120);
  SUB_BLOCK(121);
  SUB_BLOCK(122);
  SUB_BLOCK(123);
  SUB_BLOCK(124);
  SUB_BLOCK(125);
  SUB_BLOCK(126);
  SUB_BLOCK(127);
  SUB_BLOCK(128);
  SUB_BLOCK(129);
  SUB_BLOCK(130);
  SUB_BLOCK(131);
  SUB_BLOCK(132);
  SUB_BLOCK(133);
  SUB_BLOCK(134);
  SUB_BLOCK(135);
  SUB_BLOCK(136);
  SUB_BLOCK(137);
  SUB_BLOCK(138);
  SUB_BLOCK(139);
  SUB_BLOCK(140);
  SUB_BLOCK(141);
  SUB_BLOCK(142);
  SUB_BLOCK(143);
  SUB_BLOCK(144);
  SUB_BLOCK(145);
  SUB_BLOCK(146);
  SUB_BLOCK(147);
  SUB_BLOCK(148);
  SUB_BLOCK(149);
  SUB_BLOCK(150);
  SUB_BLOCK(151);
  SUB_BLOCK(152);
  SUB_BLOCK(153);
  SUB_BLOCK(154);
  SUB_BLOCK(155);
  SUB_BLOCK(156);
  SUB_BLOCK(157);
  SUB_BLOCK(158);
  SUB_BLOCK(159);
  SUB_BLOCK(160);
  SUB_BLOCK(161);
  SUB_BLOCK(162);
  SUB_BLOCK(163);
  SUB_BLOCK(164);
  SUB_BLOCK(165);
  SUB_BLOCK(166);
  SUB_BLOCK(167);
  SUB_BLOCK(168);
  SUB_BLOCK(169);
  SUB_BLOCK(170);
  SUB_BLOCK(171);
  SUB_BLOCK(172);
  SUB_BLOCK(173);
  SUB_BLOCK(174);
  SUB_BLOCK(175);
  SUB_BLOCK(176);
  SUB_BLOCK(177);
  SUB_BLOCK(178);
  SUB_BLOCK(179);
  SUB_BLOCK(180);
  SUB_BLOCK(181);
  SUB_BLOCK(182);
  SUB_BLOCK(183);
  SUB_BLOCK(184);
  SUB_BLOCK(185);
  SUB_BLOCK(186);
  SUB_BLOCK(187);
  SUB_BLOCK(188);
  SUB_BLOCK(189);
  SUB_BLOCK(190);
  SUB_BLOCK(191);
  SUB_BLOCK(192);
  SUB_BLOCK(193);
  SUB_BLOCK(194);
  SUB_BLOCK(195);
  SUB_BLOCK(196);
  SUB_BLOCK(197);
  SUB_BLOCK(198);
  SUB_BLOCK(199);
  SUB_BLOCK(200);
  SUB_BLOCK(201);
  SUB_BLOCK(202);
  SUB_BLOCK(203);
  SUB_BLOCK(204);
  SUB_BLOCK(205);
  SUB_BLOCK(206);
  SUB_BLOCK(207);
  SUB_BLOCK(208);
  SUB_BLOCK(209);
  SUB_BLOCK(210);
  SUB_BLOCK(211);
  SUB_BLOCK(212);
  SUB_BLOCK(213);
  SUB_BLOCK(214);
  SUB_BLOCK(215);
  SUB_BLOCK(216);
  SUB_BLOCK(217);
  SUB_BLOCK(218);
  SUB_BLOCK(219);
  SUB_BLOCK(220);
  SUB_BLOCK(221);
  SUB_BLOCK(222);
  SUB_BLOCK(223);
  SUB_BLOCK(224);
  SUB_BLOCK(225);
  SUB_BLOCK(226);
  SUB_BLOCK(227);
  SUB_BLOCK(228);
  SUB_BLOCK(229);
  SUB_BLOCK(230);
  SUB_BLOCK(231);
  SUB_BLOCK(232);
  SUB_BLOCK(233);
  SUB_BLOCK(234);
  SUB_BLOCK(235);
  SUB_BLOCK(236);
  SUB_BLOCK(237);
  SUB_BLOCK(238);
  SUB_BLOCK(239);
  SUB_BLOCK(240);
  SUB_BLOCK(241);
  SUB_BLOCK(242);
  SUB_BLOCK(243);
  SUB_BLOCK(244);
  SUB_BLOCK(245);
  SUB_BLOCK(246);
  SUB_BLOCK(247);
  SUB_BLOCK(248);
  SUB_BLOCK(249);
  SUB_BLOCK(250);
  SUB_BLOCK(251);
  SUB_BLOCK(252);
  SUB_BLOCK(253);
  SUB_BLOCK(254);
  SUB_BLOCK(255);
  SUB_BLOCK(256);
  SUB_BLOCK(257);
  SUB_BLOCK(258);
  SUB_BLOCK(259);
  SUB_BLOCK(260);
  SUB_BLOCK(261);
  SUB_BLOCK(262);
  SUB_BLOCK(263);
  SUB_BLOCK(264);
  SUB_BLOCK(265);
  SUB_BLOCK(266);
  SUB_BLOCK(267);
  SUB_BLOCK(268);
  SUB_BLOCK(269);
  SUB_BLOCK(270);
  SUB_BLOCK(271);
  SUB_BLOCK(272);
  SUB_BLOCK(273);
  SUB_BLOCK(274);
  SUB_BLOCK(275);
  SUB_BLOCK(276);
  SUB_BLOCK(277);
  SUB_BLOCK(278);
  SUB_BLOCK(279);
  SUB_BLOCK(280);
  SUB_BLOCK(281);
  SUB_BLOCK(282);
  SUB_BLOCK(283);
  SUB_BLOCK(284);
  SUB_BLOCK(285);
  SUB_BLOCK(286);
  SUB_BLOCK(287);
  SUB_BLOCK(288);
  SUB_BLOCK(289);
  SUB_BLOCK(290);
  SUB_BLOCK(291);
  SUB_BLOCK(292);
  SUB_BLOCK(293);
  SUB_BLOCK(294);
  SUB_BLOCK(295);
  SUB_BLOCK(296);
  SUB_BLOCK(297);
  SUB_BLOCK(298);
  SUB_BLOCK(299);
  SUB_BLOCK(300);
  SUB_BLOCK(301);
  SUB_BLOCK(302);
  SUB_BLOCK(303);
  SUB_BLOCK(304);
  SUB_BLOCK(305);
  SUB_BLOCK(306);
  SUB_BLOCK(307);
  SUB_BLOCK(308);
  SUB_BLOCK(309);
  SUB_BLOCK(310);
  SUB_BLOCK(311);
  SUB_BLOCK(312);
  SUB_BLOCK(313);
  SUB_BLOCK(314);
  SUB_BLOCK(315);
  SUB_BLOCK(316);
  SUB_BLOCK(317);
  SUB_BLOCK(318);
  SUB_BLOCK(319);
  SUB_BLOCK(320);
  SUB_BLOCK(321);
  SUB_BLOCK(322);
  SUB_BLOCK(323);
  SUB_BLOCK(324);
  SUB_BLOCK(325);
  SUB_BLOCK(326);
  SUB_BLOCK(327);
  SUB_BLOCK(328);
  SUB_BLOCK(329);
  SUB_BLOCK(330);
  SUB_BLOCK(331);
  SUB_BLOCK(332);
  SUB_BLOCK(333);
  SUB_BLOCK(334);
  SUB_BLOCK(335);
  SUB_BLOCK(336);
  SUB_BLOCK(337);
  SUB_BLOCK(338);
  SUB_BLOCK(339);
  SUB_BLOCK(340);
  SUB_BLOCK(341);
  SUB_BLOCK(342);
  SUB_BLOCK(343);
  SUB_BLOCK(344);
  SUB_BLOCK(345);
  SUB_BLOCK(346);
  SUB_BLOCK(347);
  SUB_BLOCK(348);
  SUB_BLOCK(349);
  SUB_BLOCK(350);
  SUB_BLOCK(351);
  SUB_BLOCK(352);
  SUB_BLOCK(353);
  SUB_BLOCK(354);
  SUB_BLOCK(355);
  SUB_BLOCK(356);
  SUB_BLOCK(357);
  SUB_BLOCK(358);
  SUB_BLOCK(359);
  SUB_BLOCK(360);
  SUB_BLOCK(361);
  SUB_BLOCK(362);
  SUB_BLOCK(363);
  SUB_BLOCK(364);
  SUB_BLOCK(365);
  SUB_BLOCK(366);
  SUB_BLOCK(367);
  SUB_BLOCK(368);
  SUB_BLOCK(369);
  SUB_BLOCK(370);
  SUB_BLOCK(371);
  SUB_BLOCK(372);
  SUB_BLOCK(373);
  SUB_BLOCK(374);
  SUB_BLOCK(375);
  SUB_BLOCK(376);
  SUB_BLOCK(377);
  SUB_BLOCK(378);
  SUB_BLOCK(379);
  SUB_BLOCK(380);
  SUB_BLOCK(381);
  SUB_BLOCK(382);
  SUB_BLOCK(383);
  SUB_BLOCK(384);
  SUB_BLOCK(385);
  SUB_BLOCK(386);
  SUB_BLOCK(387);
  SUB_BLOCK(388);
  SUB_BLOCK(389);
  SUB_BLOCK(390);
  SUB_BLOCK(391);
  SUB_BLOCK(392);
  SUB_BLOCK(393);
  SUB_BLOCK(394);
  SUB_BLOCK(395);
  SUB_BLOCK(396);
  SUB_BLOCK(397);
  SUB_BLOCK(398);
  SUB_BLOCK(399);
  SUB_BLOCK(400);
  SUB_BLOCK(401);
  SUB_BLOCK(402);
  SUB_BLOCK(403);
  SUB_BLOCK(404);
  SUB_BLOCK(405);
  SUB_BLOCK(406);
  SUB_BLOCK(407);
  SUB_BLOCK(408);
  SUB_BLOCK(409);
  SUB_BLOCK(410);
  SUB_BLOCK(411);
  SUB_BLOCK(412);
  SUB_BLOCK(413);
  SUB_BLOCK(414);
  SUB_BLOCK(415);
  SUB_BLOCK(416);
  SUB_BLOCK(417);
  SUB_BLOCK(418);
  SUB_BLOCK(419);
  SUB_BLOCK(420);
  SUB_BLOCK(421);
  SUB_BLOCK(422);
  SUB_BLOCK(423);
  SUB_BLOCK(424);
  SUB_BLOCK(425);
  SUB_BLOCK(426);
  SUB_BLOCK(427);
  SUB_BLOCK(428);
  SUB_BLOCK(429);
  SUB_BLOCK(430);
  SUB_BLOCK(431);
  SUB_BLOCK(432);
  SUB_BLOCK(433);
  SUB_BLOCK(434);
  SUB_BLOCK(435);
  SUB_BLOCK(436);
  SUB_BLOCK(437);
  SUB_BLOCK(438);
  SUB_BLOCK(439);
  SUB_BLOCK(440);
  SUB_BLOCK(441);
  SUB_BLOCK(442);
  SUB_BLOCK(443);
  SUB_BLOCK(444);
  SUB_BLOCK(445);
  SUB_BLOCK(446);
  SUB_BLOCK(447);
  SUB_BLOCK(448);
  SUB_BLOCK(449);
  SUB_BLOCK(450);
  SUB_BLOCK(451);
  SUB_BLOCK(452);
  SUB_BLOCK(453);
  SUB_BLOCK(454);
  SUB_BLOCK(455);
  SUB_BLOCK(456);
  SUB_BLOCK(457);
  SUB_BLOCK(458);
  SUB_BLOCK(459);
  SUB_BLOCK(460);
  SUB_BLOCK(461);
  SUB_BLOCK(462);
  SUB_BLOCK(463);
  SUB_BLOCK(464);
  SUB_BLOCK(465);
  SUB_BLOCK(466);
  SUB_BLOCK(467);
  SUB_BLOCK(468);
  SUB_BLOCK(469);
  SUB_BLOCK(470);
  SUB_BLOCK(471);
  SUB_BLOCK(472);
  SUB_BLOCK(473);
  SUB_BLOCK(474);
  SUB_BLOCK(475);
  SUB_BLOCK(476);
  SUB_BLOCK(477);
  SUB_BLOCK(478);
  SUB_BLOCK(479);
  SUB_BLOCK(480);
  SUB_BLOCK(481);
  SUB_BLOCK(482);
  SUB_BLOCK(483);
  SUB_BLOCK(484);
  SUB_BLOCK(485);
  SUB_BLOCK(486);
  SUB_BLOCK(487);
  SUB_BLOCK(488);
  SUB_BLOCK(489);
  SUB_BLOCK(490);
  SUB_BLOCK(491);
  SUB_BLOCK(492);
  SUB_BLOCK(493);
  SUB_BLOCK(494);
  SUB_BLOCK(495);
  SUB_BLOCK(496);
  SUB_BLOCK(497);
  SUB_BLOCK(498);
  SUB_BLOCK(499);
  SUB_BLOCK(500);
  SUB_BLOCK(501);
  SUB_BLOCK(502);
  SUB_BLOCK(503);
  SUB_BLOCK(504);
  SUB_BLOCK(505);
  SUB_BLOCK(506);
  SUB_BLOCK(507);
  SUB_BLOCK(508);
  SUB_BLOCK(509);
  SUB_BLOCK(510);
  SUB_BLOCK(511);
}

#define UNIFORM_BLOCK(i) do {\
    ctr = 0;\
    extseed[NEWHOPE_SYMBYTES] = i;\
    shake128_absorb(state, extseed, NEWHOPE_SYMBYTES+1);\
    while(ctr < 64) {\
      shake128_squeezeblocks(buf,1,state);\
      for(j=0;j<SHAKE128_RATE && ctr < 64;j+=2){\
        val = (buf[j] | ((uint16_t) buf[j+1] << 8));\
        if(val < 5*NEWHOPE_Q){\
          a->coeffs[i*64+ctr] = val;\
          ctr++;\
        }\
      }\
    }\
} while(0)

void poly_uniform(poly *a, const unsigned char *seed)
{
  unsigned int ctr=0;
  uint16_t val;
  uint64_t state[25];
  uint8_t buf[SHAKE128_RATE];
  uint8_t extseed[NEWHOPE_SYMBYTES+1];
  int i,j;

  extseed[0] = seed[0];
  extseed[1] = seed[1];
  extseed[2] = seed[2];
  extseed[3] = seed[3];
  extseed[4] = seed[4];
  extseed[5] = seed[5];
  extseed[6] = seed[6];
  extseed[7] = seed[7];
  extseed[8] = seed[8];
  extseed[9] = seed[9];
  extseed[10] = seed[10];
  extseed[11] = seed[11];
  extseed[12] = seed[12];
  extseed[13] = seed[13];
  extseed[14] = seed[14];
  extseed[15] = seed[15];
  extseed[16] = seed[16];
  extseed[17] = seed[17];
  extseed[18] = seed[18];
  extseed[19] = seed[19];
  extseed[20] = seed[20];
  extseed[21] = seed[21];
  extseed[22] = seed[22];
  extseed[23] = seed[23];
  extseed[24] = seed[24];
  extseed[25] = seed[25];
  extseed[26] = seed[26];
  extseed[27] = seed[27];
  extseed[28] = seed[28];
  extseed[29] = seed[29];
  extseed[30] = seed[30];
  extseed[31] = seed[31];

  UNIFORM_BLOCK(0);
  UNIFORM_BLOCK(1);
  UNIFORM_BLOCK(2);
  UNIFORM_BLOCK(3);
  UNIFORM_BLOCK(4);
  UNIFORM_BLOCK(5);
  UNIFORM_BLOCK(6);
  UNIFORM_BLOCK(7);
}

#define SAMPLE_BLOCK(i) do{\
      extseed[NEWHOPE_SYMBYTES+1] = i;\
    shake256(buf,128,  extseed,NEWHOPE_SYMBYTES+2);\
    for(j=0;j<128;j+=4)\
    {\
      t = buf[j] | ((uint32_t)buf[j+1] << 8) | ((uint32_t)buf[j+2] << 16) | ((uint32_t)buf[j+3] << 24);\
      d = 0;\
      for(k=0;k<8;k++)\
        d += (t >> k) & 0x01010101;\
      a = d & 0xff;\
      b = ((d >>  8) & 0xff);\
      c = ((d >> 16) & 0xff);\
      d >>= 24;\
      r->coeffs[64*i+j/2]   = a + NEWHOPE_Q - b;\
      r->coeffs[64*i+j/2+1] = c + NEWHOPE_Q - d;\
    }\
} while(0)

void poly_sample(poly *r, const unsigned char *seed, unsigned char nonce)
{
#if NEWHOPE_K != 8
#error "poly_getnoise in poly.c only supports k=8"
#endif
  unsigned char buf[128];
  uint32_t t, d, a, b, c;
  int i,j,k;

  unsigned char   extseed[NEWHOPE_SYMBYTES+2];

  extseed[0] = seed[0];
  extseed[1] = seed[1];
  extseed[2] = seed[2];
  extseed[3] = seed[3];
  extseed[4] = seed[4];
  extseed[5] = seed[5];
  extseed[6] = seed[6];
  extseed[7] = seed[7];
  extseed[8] = seed[8];
  extseed[9] = seed[9];
  extseed[10] = seed[10];
  extseed[11] = seed[11];
  extseed[12] = seed[12];
  extseed[13] = seed[13];
  extseed[14] = seed[14];
  extseed[15] = seed[15];
  extseed[16] = seed[16];
  extseed[17] = seed[17];
  extseed[18] = seed[18];
  extseed[19] = seed[19];
  extseed[20] = seed[20];
  extseed[21] = seed[21];
  extseed[22] = seed[22];
  extseed[23] = seed[23];
  extseed[24] = seed[24];
  extseed[25] = seed[25];
  extseed[26] = seed[26];
  extseed[27] = seed[27];
  extseed[28] = seed[28];
  extseed[29] = seed[29];
  extseed[30] = seed[30];
  extseed[31] = seed[31];

  extseed[NEWHOPE_SYMBYTES] = nonce;

  SAMPLE_BLOCK(0);
  SAMPLE_BLOCK(1);
  SAMPLE_BLOCK(2);
  SAMPLE_BLOCK(3);
  SAMPLE_BLOCK(4);
  SAMPLE_BLOCK(5);
  SAMPLE_BLOCK(6);
  SAMPLE_BLOCK(7);
}


void poly_ntt(poly *r)
{
  mul_coefficients(r->coeffs, psis_bitrev_montgomery); 
  ntt((uint16_t *)r->coeffs, omegas_montgomery);
}

void poly_invntt(poly *r)
{
  bitrev_vector(r->coeffs);
  ntt((uint16_t *)r->coeffs, omegas_inv_montgomery);
  mul_coefficients(r->coeffs, psis_inv_montgomery);
}
